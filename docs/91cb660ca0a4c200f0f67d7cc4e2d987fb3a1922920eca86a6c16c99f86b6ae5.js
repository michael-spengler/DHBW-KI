function t(){}function e(t){return t()}function s(){return Object.create(null)}function n(t){t.forEach(e)}function i(t){return"function"==typeof t}function r(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}let a=!1;const o=new Set;function u(t,e){a&&o.delete(e),e.parentNode!==t&&t.appendChild(e)}function c(t,e,s){a&&o.delete(e),(e.parentNode!==t||s&&e.nextSibling!==s)&&t.insertBefore(e,s||null)}function l(t){a?o.add(t):t.parentNode&&t.parentNode.removeChild(t)}function h(t){return document.createElement(t)}function g(t){return document.createTextNode(t)}function d(){return g(" ")}function p(){return g("")}function f(t,e,s,n){return t.addEventListener(e,s,n),()=>t.removeEventListener(e,s,n)}function m(t,e,s){null==s?t.removeAttribute(e):t.getAttribute(e)!==s&&t.setAttribute(e,s)}function y(t){return Array.from(t.childNodes)}function D(t,e,s,n){for(;t.length>0;){const n=t.shift();if(n.nodeName===e){let t=0;const e=[];for(;t<n.attributes.length;){const i=n.attributes[t++];s[i.name]||e.push(i.name)}for(let t=0;t<e.length;t++)n.removeAttribute(e[t]);return n}l(n)}return n?function(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}(e):h(e)}function w(t,e){for(let s=0;s<t.length;s+=1){const n=t[s];if(3===n.nodeType)return n.data=""+e,t.splice(s,1)[0]}return g(e)}function v(t){return w(t," ")}function A(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function C(t,e){t.value=null==e?"":e}let x;function b(t){x=t}function F(t){(function(){if(!x)throw new Error("Function called outside component initialization");return x})().$$.on_mount.push(t)}const E=[],k=[],B=[],S=[],N=Promise.resolve();let T=!1;function O(t){B.push(t)}function P(t){S.push(t)}let L=!1;const j=new Set;function $(){if(!L){L=!0;do{for(let t=0;t<E.length;t+=1){const e=E[t];b(e),M(e.$$)}for(b(null),E.length=0;k.length;)k.pop()();for(let t=0;t<B.length;t+=1){const e=B[t];j.has(e)||(j.add(e),e())}B.length=0}while(E.length);for(;S.length;)S.pop()();T=!1,L=!1,j.clear()}}function M(t){if(null!==t.fragment){t.update(),n(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(O)}}const R=new Set;function I(t,e){t&&t.i&&(R.delete(t),t.i(e))}function z(t,e,s,n){if(t&&t.o){if(R.has(t))return;R.add(t),(void 0).c.push((()=>{R.delete(t),n&&(s&&t.d(1),n())})),t.o(e)}}function _(t,e,s){const n=t.$$.props[e];void 0!==n&&(t.$$.bound[n]=s,s(t.$$.ctx[n]))}function J(t){t&&t.c()}function W(t,e){t&&t.l(e)}function q(t,s,r,a){const{fragment:o,on_mount:u,on_destroy:c,after_update:l}=t.$$;o&&o.m(s,r),a||O((()=>{const s=u.map(e).filter(i);c?c.push(...s):n(s),t.$$.on_mount=[]})),l.forEach(O)}function V(t,e){const s=t.$$;null!==s.fragment&&(n(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}function U(t,e){-1===t.$$.dirty[0]&&(E.push(t),T||(T=!0,N.then($)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function K(e,i,r,u,c,h,g=[-1]){const d=x;b(e);const p=e.$$={fragment:null,ctx:null,props:h,update:t,not_equal:c,bound:s(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(d?d.$$.context:i.context||[]),callbacks:s(),dirty:g,skip_bound:!1};let f=!1;if(p.ctx=r?r(e,i.props||{},((t,s,...n)=>{const i=n.length?n[0]:s;return p.ctx&&c(p.ctx[t],p.ctx[t]=i)&&(!p.skip_bound&&p.bound[t]&&p.bound[t](i),f&&U(e,t)),s})):[],p.update(),f=!0,n(p.before_update),p.fragment=!!u&&u(p.ctx),i.target){if(i.hydrate){a=!0;const t=y(i.target);p.fragment&&p.fragment.l(t),t.forEach(l)}else p.fragment&&p.fragment.c();i.intro&&I(e.$$.fragment),q(e,i.target,i.anchor,i.customElement),function(){a=!1;for(const t of o)t.parentNode.removeChild(t);o.clear()}(),$()}b(d)}class G{$destroy(){V(this,1),this.$destroy=t}$on(t,e){const s=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return s.push(e),()=>{const t=s.indexOf(e);-1!==t&&s.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function H(t,e,s){const n=t.slice();return n[3]=e[s],n}function Q(t){let e,s,n,i=t[3].text+"";return{c(){e=h("div"),s=g(i),n=d(),this.h()},l(t){e=D(t,"DIV",{class:!0});var r=y(e);s=w(r,i),n=v(r),r.forEach(l),this.h()},h(){m(e,"class","messageByUser svelte-fx96uy")},m(t,i){c(t,e,i),u(e,s),u(e,n)},p(t,e){1&e&&i!==(i=t[3].text+"")&&A(s,i)},d(t){t&&l(e)}}}function Z(t){let e,s;function n(t,e){return t[1]||t[3].text!==t[0][0].text?Y:X}let i=n(t),r=i(t);return{c(){e=h("div"),r.c(),s=d(),this.h()},l(t){e=D(t,"DIV",{class:!0});var n=y(e);r.l(n),s=v(n),n.forEach(l),this.h()},h(){m(e,"class","messageByBot svelte-fx96uy")},m(t,n){c(t,e,n),r.m(e,null),u(e,s)},p(t,a){i===(i=n(t))&&r?r.p(t,a):(r.d(1),r=i(t),r&&(r.c(),r.m(e,s)))},d(t){t&&l(e),r.d()}}}function X(t){let e;return{c(){e=g(t[2])},l(s){e=w(s,t[2])},m(t,s){c(t,e,s)},p(t,s){4&s&&A(e,t[2])},d(t){t&&l(e)}}}function Y(t){let e,s=t[3].text+"";return{c(){e=g(s)},l(t){e=w(t,s)},m(t,s){c(t,e,s)},p(t,n){1&n&&s!==(s=t[3].text+"")&&A(e,s)},d(t){t&&l(e)}}}function tt(t){let e;function s(t,e){return t[3].bot?Z:Q}let n=s(t),i=n(t);return{c(){i.c(),e=p()},l(t){i.l(t),e=p()},m(t,s){i.m(t,s),c(t,e,s)},p(t,r){n===(n=s(t))&&i?i.p(t,r):(i.d(1),i=n(t),i&&(i.c(),i.m(e.parentNode,e)))},d(t){i.d(t),t&&l(e)}}}function et(e){let s,n=e[0],i=[];for(let t=0;t<n.length;t+=1)i[t]=tt(H(e,n,t));return{c(){s=h("div");for(let t=0;t<i.length;t+=1)i[t].c();this.h()},l(t){s=D(t,"DIV",{class:!0});var e=y(s);for(let t=0;t<i.length;t+=1)i[t].l(e);e.forEach(l),this.h()},h(){m(s,"class","messageBox svelte-fx96uy")},m(t,e){c(t,s,e);for(let t=0;t<i.length;t+=1)i[t].m(s,null)},p(t,[e]){if(7&e){let r;for(n=t[0],r=0;r<n.length;r+=1){const a=H(t,n,r);i[r]?i[r].p(a,e):(i[r]=tt(a),i[r].c(),i[r].m(s,null))}for(;r<i.length;r+=1)i[r].d(1);i.length=n.length}},i:t,o:t,d(t){t&&l(s),function(t,e){for(let s=0;s<t.length;s+=1)t[s]&&t[s].d(e)}(i,t)}}}function st(t,e,s){let{messages:n}=e,i=!1,r="";return F((async()=>{let t=0;setInterval((()=>{t++,s(2,r=n[0].text.substr(0,t))}),20),r===n[0].text&&(s(1,i=!0),t=0)})),t.$$set=t=>{"messages"in t&&s(0,n=t.messages)},[n,i,r]}class nt extends G{constructor(t){var e;super(),document.getElementById("svelte-fx96uy-style")||((e=h("style")).id="svelte-fx96uy-style",e.textContent=".messageBox.svelte-fx96uy{background-color:white;color:black;min-height:70vh}.messageByBot.svelte-fx96uy{padding-left:0.2vw;padding-top:2vh;text-align:left}.messageByUser.svelte-fx96uy{padding-right:0.2vw;padding-top:2vh;text-align:right}",u(document.head,e)),K(this,t,st,et,r,{messages:0})}}function it(e){let s,n,i,r,a;return{c(){s=h("div"),n=g("Please wait about 10 seconds until I trained with the latest "),i=h("a"),r=g("training data"),a=g("."),this.h()},l(t){s=D(t,"DIV",{id:!0,class:!0});var e=y(s);n=w(e,"Please wait about 10 seconds until I trained with the latest "),i=D(e,"A",{href:!0,target:!0});var o=y(i);r=w(o,"training data"),o.forEach(l),a=w(e,"."),e.forEach(l),this.h()},h(){m(i,"href","https://github.com/michael-spengler/DHBW-Learning-Apps/blob/main/training-data.md"),m(i,"target","_blank"),m(s,"id","wait"),m(s,"class","svelte-11mt8c4")},m(t,e){c(t,s,e),u(s,n),u(s,i),u(i,r),u(s,a)},p:t,d(t){t&&l(s)}}}function rt(t){let e,s,i,r,a,o;return{c(){e=h("input"),s=d(),i=h("button"),r=g("Send"),this.h()},l(t){e=D(t,"INPUT",{type:!0,name:!0,id:!0,style:!0,placeholder:!0,autofocus:!0}),s=v(t),i=D(t,"BUTTON",{class:!0});var n=y(i);r=w(n,"Send"),n.forEach(l),this.h()},h(){m(e,"type","text"),m(e,"name",""),m(e,"id",""),e.style.setProperty("width","70vw",""),m(e,"placeholder","Enter your question here..."),e.autofocus=!0,m(i,"class","svelte-11mt8c4")},m(n,l){c(n,e,l),C(e,t[1]),c(n,s,l),c(n,i,l),u(i,r),e.focus(),a||(o=[f(e,"input",t[4]),f(e,"keyup",t[5]),f(i,"click",t[6])],a=!0)},p(t,s){2&s&&e.value!==t[1]&&C(e,t[1])},d(t){t&&l(e),t&&l(s),t&&l(i),a=!1,n(o)}}}function at(e){let s;function n(t,e){return t[0]?rt:it}let i=n(e),r=i(e);return{c(){s=h("div"),r.c(),this.h()},l(t){s=D(t,"DIV",{class:!0});var e=y(s);r.l(e),e.forEach(l),this.h()},h(){m(s,"class","inputArea svelte-11mt8c4")},m(t,e){c(t,s,e),r.m(s,null)},p(t,[e]){i===(i=n(t))&&r?r.p(t,e):(r.d(1),r=i(t),r&&(r.c(),r.m(s,null)))},i:t,o:t,d(t){t&&l(s),r.d()}}}function ot(t,e,s){let n="",{sendMessage:i=(()=>{})}=e,{readyForInput:r}=e;function a(){r?(i(n),s(1,n="")):alert("Please send this message once more :)")}return t.$$set=t=>{"sendMessage"in t&&s(3,i=t.sendMessage),"readyForInput"in t&&s(0,r=t.readyForInput)},[r,n,a,i,function(){n=this.value,s(1,n)},t=>"Enter"===t.key&&a(),()=>a()]}class ut extends G{constructor(t){var e;super(),document.getElementById("svelte-11mt8c4-style")||((e=h("style")).id="svelte-11mt8c4-style",e.textContent=".inputArea.svelte-11mt8c4{position:absolute;bottom:11px}button.svelte-11mt8c4{width:15vw;font-weight:bolder}#wait.svelte-11mt8c4{color:white\n    }",u(document.head,e)),K(this,t,ot,at,r,{sendMessage:3,readyForInput:0})}}const ct=function(...t){let e;return e="object"==typeof t[0]?t[0]:[].slice.call(t),lt(e)},lt=t=>{const e=[];if(0===t.length)return"";if("string"!=typeof t[0])throw new TypeError("Url must be a string. Received "+t[0]);if(t[0].match(/^[^/:]+:\/*$/)&&t.length>1){const e=t.shift();t[0]=e+t[0]}t[0].match(/^file:\/\/\//)?t[0]=t[0].replace(/^([^/:]+):\/*/,"$1:///"):t[0]=t[0].replace(/^([^/:]+):\/*/,"$1://");for(let s=0;s<t.length;s++){let n=t[s];if("string"!=typeof n)throw new TypeError("Url must be a string. Received "+n);""!==n&&(s>0&&(n=n.replace(/^[\/]+/,"")),n=s<t.length-1?n.replace(/[\/]+$/,""):n.replace(/[\/]+$/,"/"),e.push(n))}let s=e.join("/");s=s.replace(/\/(\?|&|#[^!])/g,"$1");let n=s.split("?");return s=n.shift()+(n.length>0?"?":"")+n.join("&"),s},ht=["get","post","put","delete","options","head","connect","trace","patch"];function gt(t,e){return"string"==typeof t?gt.request(Object.assign({},gt.defaults,{url:t},e)):gt.request(Object.assign({},gt.defaults,t))}gt.defaults={url:"/",method:"get",timeout:0,withCredentials:!1,validateStatus:t=>t>=200&&t<300},gt.create=t=>{const e=Object.assign({},gt);return e.defaults=Object.assign({},gt.defaults,t),e.defaults.timeout=1e3,e},gt.request=({url:t="/",baseURL:e,method:s,headers:n,params:i,data:r,timeout:a,withCredentials:o,auth:u,validateStatus:c,paramsSerializer:l,transformRequest:h,transformResponse:g})=>{if(e&&(t=ct(e,t)),s){if(-1===ht.indexOf(s.toLowerCase().trim()))throw new Error(`Method ${s} is not supported`);s=s.toLowerCase().trim()}else s="get";let d="";i&&(d=l?l(i):Object.keys(i).map((t=>encodeURIComponent(t)+"="+encodeURIComponent(i[t]))).join("&")),o&&u?.username&&u?.password&&(n||(n={}),n.Authorization="Basic "+btoa(unescape(encodeURIComponent(`${u.username}:${u.password}`))));const p={};if("get"!==s&&(p.method=s.toUpperCase()),d&&(t=ct(t,"?"+d)),r&&"get"!==s){if(h&&Array.isArray(h)&&h.length>0)for(var f=0;f<(h||[]).length;f++)h&&h[f]&&(r=h[f](r,n));if("string"==typeof r||r instanceof FormData)p.body=r;else try{p.body=JSON.stringify(r),n||(n={}),n.Accept="application/json",n["Content-Type"]="application/json"}catch(t){}}if(n){const t=new Headers;Object.keys(n).forEach((e=>{n&&n[e]&&t.set(e,n[e])})),p.headers=t}return fetch(t,p).then((async h=>{const d=h.status,p=h.statusText;let f=null;if(-1===(h.headers.get("content-type")||"").toLowerCase().indexOf("json"))try{f=await h.clone().json()}catch(t){f=await h.clone().text()}else f=await h.clone().json();if(g&&g&&Array.isArray(g)&&g.length>0)for(var m=0;m<(g||[]).length;m++)g&&g[m]&&(f=g[m](f));const y=h.headers,D={url:t,baseURL:e,method:s,headers:n,params:i,data:r,timeout:a,withCredentials:o,auth:u,paramsSerializer:l};let w=!0;if(w=c?c(d):d>=200&&d<300,w)return Promise.resolve({status:d,statusText:p,data:f,headers:y,config:D});{const t={response:{status:d,statusText:p,data:f,headers:y},config:D};return Promise.reject(t)}}))},gt.get=(t,e)=>gt.request(Object.assign({},{url:t},e,{method:"get"})),gt.post=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"post",data:e})),gt.put=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"put",data:e})),gt.delete=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"delete",data:e})),gt.options=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"options",data:e})),gt.head=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"head",data:e})),gt.connect=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"connect",data:e})),gt.trace=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"trace",data:e})),gt.patch=(t,e,s)=>gt.request(Object.assign({},{url:t},s,{method:"patch",data:e}));class dt{async getQAPairsFromMarkDown(){const t=[],e=(await gt.get("https://raw.githubusercontent.com/michael-spengler/DHBW-KI/main/training-data.md")).data.split("\n## ");for(const s of e){const e=s.split("\n###");if(1===e.length);else for(const s of e){const e={q:s.split("\n")[0].trim(),a:s.split("\n")[1].trim()};t.push(e)}}return t}getDocuments(t){const e=[];for(const s of t){const t={lang:"de",utterance:s.q,intent:s.q};e.push(t)}return e}getAnswers(t){const e=[];for(const s of t){const t={lang:"de",intent:s.q,output:s.a};e.push(t)}return e}}var pt=class{constructor(t,e,s,n,i){this.s_size=t.length,this.s=t,this.substring_i=e,this.result=s,this.method=n,this.instance=i}};function ft(){throw new Error("setTimeout has not been defined")}function mt(){throw new Error("clearTimeout has not been defined")}var yt,Dt=ft,wt=mt;function vt(t){if(Dt===setTimeout)return setTimeout(t,0);if((Dt===ft||!Dt)&&setTimeout)return Dt=setTimeout,setTimeout(t,0);try{return Dt(t,0)}catch(e){try{return Dt.call(null,t,0)}catch(e){return Dt.call(this,t,0)}}}"function"==typeof(yt="undefined"!=typeof window?window:"undefined"!=typeof self?self:{}).setTimeout&&(Dt=setTimeout),"function"==typeof yt.clearTimeout&&(wt=clearTimeout);var At,Ct=[],xt=!1,bt=-1;function Ft(){xt&&At&&(xt=!1,At.length?Ct=At.concat(Ct):bt=-1,Ct.length&&Et())}function Et(){if(!xt){var t=vt(Ft);xt=!0;for(var e=Ct.length;e;){for(At=Ct,Ct=[];++bt<e;)At&&At[bt].run();bt=-1,e=Ct.length}At=null,xt=!1,function(t){if(wt===clearTimeout)return clearTimeout(t);if((wt===mt||!wt)&&clearTimeout)return wt=clearTimeout,clearTimeout(t);try{wt(t)}catch(e){try{return wt.call(null,t)}catch(e){return wt.call(this,t)}}}(t)}}function kt(t,e){this.fun=t,this.array=e}function Bt(){}kt.prototype.run=function(){this.fun.apply(null,this.array)};var St=Bt,Nt=Bt,Tt=Bt,Ot=Bt,Pt=Bt,Lt=Bt,jt=Bt,$t=yt.performance||{},Mt=$t.now||$t.mozNow||$t.msNow||$t.oNow||$t.webkitNow||function(){return(new Date).getTime()},Rt=new Date,It={nextTick:function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];Ct.push(new kt(t,e)),1!==Ct.length||xt||vt(Et)},title:"browser",browser:!0,env:{NODE_ENV:"production"},argv:[],version:"",versions:{},on:St,addListener:Nt,once:Tt,off:Ot,removeListener:Pt,removeAllListeners:Lt,emit:jt,binding:function(t){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(t){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(t){var e=.001*Mt.call($t),s=Math.floor(e),n=Math.floor(e%1*1e9);return t&&(s-=t[0],(n-=t[1])<0&&(s--,n+=1e9)),[s,n]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-Rt)/1e3}};const zt="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\u1ab0-\\u1aff\\u1dc0-\\u1dff",_t="[\\ud800-\\udfff]",Jt=`[${zt}]`,Wt="\\ud83c[\\udffb-\\udfff]",qt="[^\\ud800-\\udfff]",Vt="(?:\\ud83c[\\udde6-\\uddff]){2}",Ut="[\\ud800-\\udbff][\\udc00-\\udfff]",Kt=`(?:${Jt}|${Wt})?`,Gt="[\\ufe0e\\ufe0f]?"+Kt+`(?:\\u200d(?:${[qt,Vt,Ut].join("|")})${"[\\ufe0e\\ufe0f]?"+Kt})*`,Ht=`(?:${[`${qt}${Jt}?`,Jt,Vt,Ut,_t].join("|")})`,Qt=RegExp(`[${"\\u200d\\ud800-\\udfff"+zt+"\\ufe0e\\ufe0f"}]`),Zt=RegExp(`${Wt}(?=${Wt})|${Ht+Gt}`,"g"),Xt=t=>Qt.test(t),Yt=t=>t.match(Zt)||[],te=t=>t.split("");var ee={hasUnicode:Xt,unicodeToArray:Yt,asciiToArray:te,stringToArray:t=>Xt(t)?Yt(t):te(t),compareWildcars:function(t,e){const s=`^${e.split("*").map((t=>t.replace(/([.*+^=!:${}()|[\]/\\])/g,"\\$1"))).join(".*")}$`.replace(/\?/g,".");return new RegExp(s).test(t)},loadEnvFromJson:function(t,e={}){const s=Object.keys(e);t=t?t+"_":"";for(let n=0;n<s.length;n+=1){const i=`${t}${s[n]}`;It.env[i]=e[s[n]]}}},se=class{constructor(t){this.container=t.container||t,this.name="default"}getTokenFromWord(t){return t.startsWith("//")?{type:"comment",value:t}:["set","delete","get","inc","dec","eq","neq","gt","ge","lt","le","label","goto","jne","je"].includes(t)?{type:t,arguments:[]}:t.startsWith("$")?{type:"call",value:t.slice(1)}:{type:"reference",value:t}}compile(t){const e=[];for(let s=0;s<t.length;s+=1){const n=t[s].trim().split(" "),i=[];let r,a="";for(let t=0;t<n.length;t+=1){const e=n[t];let s=!1;r?(a=`${a} ${e}`,s=!0,e.endsWith(r)&&(r=void 0,i.push(this.getTokenFromWord(a)))):e.startsWith('"')?(a=e,s=!0,r='"',e.endsWith('"')&&(r=void 0,i.push(this.getTokenFromWord(a)))):e.startsWith("'")&&(a=e,s=!0,r="'",e.endsWith("'")&&(r=void 0,i.push(this.getTokenFromWord(a)))),s||i.push(this.getTokenFromWord(e))}e.push(i)}return e}executeCall(t,e,s,n,i){const r=this.container.getPipeline(t.value);if(!r)throw new Error(`Pipeline $${t.value} not found.`);return this.container.runPipeline(r,s,n,i+1)}executeReference(t,e,s,n,i){const r=this.container.resolvePath(e.value,s,n,i),a=[];for(let e=1;e<t.length;e+=1)a.push(this.container.resolvePathWithType(t[e].value,s,n,i));if(!r)throw new Error("Method not found for step "+JSON.stringify(t));const o=r.run||r;return"function"==typeof o?"function"==typeof r?o(n,...a):o.bind(r)(n,...a):o}doGoto(t,e){const s=e,n=s.labels[t];s.cursor=n}async executeAction(t,e,s,n,i){let r=t[0];if(r&&r.value&&r.value.startsWith("->")){if(i>0)return s;r={...r},r.value=r.value.slice(2)}switch(r.type){case"set":this.container.setValue(t[1].value,t[2]?t[2].value:void 0,e,s,n);break;case"delete":this.container.deleteValue(t[1].value,e,s,n);break;case"get":return this.container.getValue(t[1]?t[1].value:void 0,e,s,n);case"inc":this.container.incValue(t[1]?t[1].value:void 0,t[2]?t[2].value:"1",e,s,n);break;case"dec":this.container.decValue(t[1]?t[1].value:void 0,t[2]?t[2].value:"1",e,s,n);break;case"eq":this.container.eqValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"neq":this.container.neqValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"gt":this.container.gtValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"ge":this.container.geValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"lt":this.container.ltValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"le":this.container.leValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,s,n);break;case"goto":this.doGoto(t[1].value,e);break;case"jne":e.floating||this.doGoto(t[1].value,e);break;case"je":e.floating&&this.doGoto(t[1].value,e);break;case"call":return this.executeCall(r,e,s,n,i);case"reference":return this.executeReference(t,r,e,s,n)}return s}findLabels(t,e){const s=e;for(let e=0;e<t.length;e+=1){const n=t[e];"label"===n[0].type&&(s[n[1].value]=e)}}async execute(t,e,s,n){let i=e;const r={cursor:0,labels:{}};for(this.findLabels(t,r.labels);r.cursor<t.length;)i=await this.executeAction(t[r.cursor],r,i,s,n),r.cursor+=1;return i}},ne=new class{constructor(){this.name="logger"}debug(...t){console.debug(...t)}info(...t){console.info(...t)}warn(...t){console.warn(...t)}error(...t){console.error(...t)}log(...t){console.log(...t)}trace(...t){console.trace(...t)}fatal(...t){console.error(...t)}};const{compareWildcars:ie}=ee;class re{constructor(t=!1){this.classes={},this.factory={},this.pipelines={},this.configurations={},this.compilers={},this.cache={bestKeys:{},pipelines:{}},this.registerCompiler(se),t||this.use(ne)}registerCompiler(t,e){const s=new t(this);this.compilers[e||s.name]=s}addClass(t,e){this.classes[e||t.name]=t}toJSON(t){const e=t.toJSON?t.toJSON():{...t};return e.className=t.constructor.name,e}fromJSON(t,e){const s=this.classes[t.className];let n;return s?(n=new s(e),n.fromJSON?n.fromJSON(t):Object.assign(n,t)):n={...t},delete n.className,n}register(t,e,s=!0){this.cache.bestKeys={};const n="function"==typeof e,i={name:t,isSingleton:s};i.instance=s?n?new e:e:n?e:e.constructor,this.factory[t]=i}getBestKey(t){if(void 0!==this.cache.bestKeys[t])return this.cache.bestKeys[t];const e=Object.keys(this.factory);for(let s=0;s<e.length;s+=1)if(ie(t,e[s]))return this.cache.bestKeys[t]=e[s],e[s];this.cache.bestKeys[t]=null}get(t,e){let s=this.factory[t];if(!s){if(this.parent)return this.parent.get(t,e);const n=this.getBestKey(t);if(n&&(s=this.factory[n]),!s)return}return s.isSingleton?(s.instance&&s.instance.applySettings&&s.instance.applySettings(s.instance.settings,e),s.instance):new(0,s.instance)(e,this)}buildLiteral(t,e,s,n){return{type:"literal",subtype:t,src:e,value:s,context:n,container:this}}resolvePathWithType(t,e,s,n){const i=t.split(".");let r=i[0].trim();if(r||(r=t.startsWith(".")?"this":"context"),/^\d+$/.test(r))return this.buildLiteral("number",t,parseFloat(r),e);if(r.startsWith('"'))return this.buildLiteral("string",t,r.replace(/^"(.+(?="$))"$/,"$1"),e);if(r.startsWith("'"))return this.buildLiteral("string",t,r.replace(/^'(.+(?='$))'$/,"$1"),e);if("true"===r)return this.buildLiteral("boolean",t,!0,e);if("false"===r)return this.buildLiteral("boolean",t,!1,e);let a=e;"input"===r||"output"===r?a=s:r&&"context"!==r&&"this"!==r?a=this.get(r)||a[r]:"this"===r&&(a=n);for(let e=1;e<i.length;e+=1){const s=i[e];if((!a||!a[s])&&e<i.length-1)throw Error(`Path not found in pipeline "${t}"`);const n=a;a=a[s],"function"==typeof a&&(a=a.bind(n))}return"function"==typeof a?{type:"function",src:t,value:a,context:e,container:this}:{type:"reference",src:t,value:a,context:e,container:this}}resolvePath(t,e,s,n){const i=this.resolvePathWithType(t,e,s,n);return i?i.value:i}setValue(t,e,s,n,i){const r=this.resolvePath(e,s,n,i),a=t.split("."),o=a.slice(0,-1).join(".");this.resolvePath(o,s,n,i)[a[a.length-1]]=r}incValue(t,e,s,n,i){const r=this.resolvePath(e,s,n,i),a=t.split(".");t.startsWith(".")&&a.push("this");const o=a.slice(0,-1).join(".");this.resolvePath(o,s,n,i)[a[a.length-1]]+=r}decValue(t,e,s,n,i){const r=this.resolvePath(e,s,n,i),a=t.split("."),o=a.slice(0,-1).join(".");this.resolvePath(o,s,n,i)[a[a.length-1]]-=r}eqValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a===o}neqValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a!==o}gtValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a>o}geValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a>=o}ltValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a<o}leValue(t,e,s,n,i){const r=s,a=this.resolvePath(t,r,n,i),o=this.resolvePath(e,r,n,i);r.floating=a<=o}deleteValue(t,e,s,n){const i=t.split("."),r=i.slice(0,-1).join(".");delete this.resolvePath(r,e,s,n)[i[i.length-1]]}getValue(t,e,s,n){const i=(t||"floating").split("."),r=i.slice(0,-1).join(".");return this.resolvePath(r,e,s,n)[i[i.length-1]]}async runPipeline(t,e,s,n=0){if(n>10)throw new Error("Pipeline depth is too high: perhaps you are using recursive pipelines?");const i="string"==typeof t?this.getPipeline(t):t;if(!i)throw new Error("Pipeline not found "+t);if(!i.compiler){const t=JSON.stringify(i);this.registerPipeline(t,i,!1);const r=this.getPipeline(t);return r.compiler.execute(r.compiled,e,s,n)}return i.compiler.execute(i.compiled,e,s,n)}use(t,e,s,n=!1){let i;if("function"==typeof t){if(t.name.endsWith("Compiler"))return this.registerCompiler(t),t.name;i=new t({container:this})}else i=t;i.register&&i.register(this);const r=i.settings?i.settings.tag:void 0,a=e||i.name||r||t.name||i.constructor.name;return n&&this.get(a)||this.register(a,i,s),a}getCompiler(t){return this.compilers[t]||(this.parent?this.parent.getCompiler(t):this.compilers.default)}buildPipeline(t,e=[]){const s=[];if(t&&t.length>0)for(let n=0;n<t.length;n+=1){const i=t[n];if("$super"===i.trim())for(let t=0;t<e.length;t+=1)e[t].trim().startsWith("->")||s.push(e[t]);else s.push(i)}const n=s.length&&s[0].startsWith("// compiler=")?s[0].slice(12):"default",i=this.getCompiler(n),r=i.compile(s);return{pipeline:s,compiler:i,compiled:r}}registerPipeline(t,e,s=!0){if(s||!this.pipelines[t]){this.cache.pipelines={};const s=this.getPipeline(t);this.pipelines[t]=this.buildPipeline(e,s?s.pipeline:[])}}registerPipelineForChilds(t,e,s,n=!0){this.childPipelines||(this.childPipelines={}),this.childPipelines[t]||(this.childPipelines[t]=[]),this.childPipelines[t].push({tag:e,pipeline:s,overwrite:n})}getPipeline(t){if(this.pipelines[t])return this.pipelines[t];if(void 0!==this.cache.pipelines[t])return this.cache.pipelines[t]||void 0;const e=Object.keys(this.pipelines);for(let s=0;s<e.length;s+=1)if(ie(t,e[s]))return this.cache.pipelines[t]=this.pipelines[e[s]],this.pipelines[e[s]];this.cache.pipelines[t]=null}registerConfiguration(t,e,s=!0){!s&&this.configurations[t]||(this.configurations[t]=e)}getConfiguration(t){if(this.configurations[t])return this.configurations[t];const e=Object.keys(this.configurations);for(let s=0;s<e.length;s+=1)if(ie(t,e[s]))return this.configurations[e[s]]}loadPipelinesFromString(t=""){const e=t.split(/\n|\r|\r\n/);let s="",n=[],i="";for(let t=0;t<e.length;t+=1){const r=e[t];""!==r&&(r.startsWith("# ")?(s&&(i&&!["default","pipelines"].includes(i.toLowerCase())?this.registerPipelineForChilds(i,s,n):this.registerPipeline(s,n)),i=r.slice(1).trim(),s="",n=[]):r.startsWith("## ")?(s&&(i&&!["default","pipelines"].includes(i.toLowerCase())?this.registerPipelineForChilds(i,s,n):this.registerPipeline(s,n)),s=r.slice(2).trim(),n=[]):s&&n.push(r))}s&&(i&&!["default","pipelines"].includes(i.toLowerCase())?this.registerPipelineForChilds(i,s,n):this.registerPipeline(s,n))}async start(t="main"){const e=Object.keys(this.factory);for(let t=0;t<e.length;t+=1){const s=this.factory[e[t]];s.isSingleton&&s.instance&&s.instance.start&&await s.instance.start()}this.getPipeline(t)&&await this.runPipeline(t,{},this)}}const ae=new re;var oe={Container:re,defaultContainer:ae};const{defaultContainer:ue}=oe;class ce{constructor(t=ue){this.container=t.container||t,this.name="arrToObj"}static arrToObj(t){const e={};for(let s=0;s<t.length;s+=1)e[t[s]]=1;return e}run(t){return Array.isArray(t)?ce.arrToObj(t):(t.tokens=ce.arrToObj(t.tokens),t)}}var le=ce;const{defaultContainer:he}=oe;var ge=class{constructor(t=he){this.container=t.container||t,this.name="normalize"}normalize(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}run(t){const e=t,s=e.locale||"en",n=this.container.get("normalizer-"+s)||this;return e.text=n.normalize(e.text,e),e}};const{defaultContainer:de}=oe;var pe=class{constructor(t=de,e=!1){this.container=t.container||t,this.name="tokenize",this.shouldNormalize=e}getNormalizer(){return this.normalizer||(this.normalizer=this.container.get("normalizer-"+this.name.slice(-2))||new ge),this.normalizer}normalize(t,e){return void 0===e&&this.shouldNormalize||!0===e?this.getNormalizer().normalize(t):t}innerTokenize(t){return t.split(/[\s,.!?;:([\]'"¡¿)/]+/).filter((t=>t))}tokenize(t,e){let s;if(this.cache){const t=new Date;Math.abs(t.getTime()-this.cache.created)/36e5>1&&(this.cache=void 0)}if(this.cache){if(s=e?this.cache.normalized[t]:this.cache.nonNormalized[t],s)return s}else this.cache={created:(new Date).getTime(),normalized:{},nonNormalized:{}};return s=this.innerTokenize(this.normalize(t,e),e),e?this.cache.normalized[t]=s:this.cache.nonNormalized[t]=s,s}async run(t){const e=t,s=e.locale||"en";let n=this.container.get("tokenizer-"+s);if(!n){const t=this.container.get("tokenizer-bert");n=t&&t.activeFor(s)?t:this}const i=await n.tokenize(e.text,e);return e.tokens=i.filter((t=>t)),e}};const{defaultContainer:fe}=oe;var me=class{constructor(t=fe,e){this.container=t.container||t,this.cache={},this.setCurrent(""),this.dictionary=e||{before:{},after:{}}}setCurrent(t){this.current=t,this.cursor=0,this.limit=this.current.length,this.limit_backward=0,this.bra=this.cursor,this.ket=this.limit}getCurrent(){return this.current}bc(t,e){return 0==(t[e>>>3]&1<<(7&e))}in_grouping(t,e,s){if(this.cursor>=this.limit)return!1;let n=this.current.charCodeAt(this.cursor);return!(n>s||n<e||(n-=e,this.bc(t,n)||(this.cursor++,0)))}in_grouping_b(t,e,s){if(this.cursor<=this.limit_backward)return!1;let n=this.current.charCodeAt(this.cursor-1);return!(n>s||n<e||(n-=e,this.bc(t,n)||(this.cursor--,0)))}out_grouping(t,e,s){if(this.cursor>=this.limit)return!1;let n=this.current.charCodeAt(this.cursor);return n>s||n<e?(this.cursor++,!0):(n-=e,!!this.bc(t,n)&&(this.cursor++,!0))}out_grouping_b(t,e,s){if(this.cursor<=this.limit_backward)return!1;let n=this.current.charCodeAt(this.cursor-1);return n>s||n<e?(this.cursor--,!0):(n-=e,!!this.bc(t,n)&&(this.cursor--,!0))}eq_s(t,e){return"string"==typeof t&&(t=(e=t).length),!(this.limit-this.cursor<t||this.current.slice(this.cursor,this.cursor+t)!=e||(this.cursor+=t,0))}eq_s_b(t,e){return"string"==typeof t&&(t=(e=t).length),!(this.cursor-this.limit_backward<t||this.current.slice(this.cursor-t,this.cursor)!=e||(this.cursor-=t,0))}find_among(t,e){let s=0,n=e||t.length;const i=this.cursor,r=this.limit;let a=0,o=0,u=!1;for(;;){const e=s+(n-s>>>1);let h=0,g=a<o?a:o;var c,l=t[e];for(c=g;c<l.s_size;c++){if(i+g==r){h=-1;break}if(h=this.current.charCodeAt(i+g)-l.s.charCodeAt(c),0!=h)break;g++}if(h<0?(n=e,o=g):(s=e,a=g),n-s<=1){if(s>0)break;if(n==s)break;if(u)break;u=!0}}for(;;){if(a>=(l=t[s]).s_size){if(this.cursor=i+l.s_size,null==l.method)return l.result;const t=l.method(l.instance);if(this.cursor=i+l.s_size,t)return l.result}if(s=l.substring_i,s<0)return 0}return-1}find_among_b(t,e){let s=0,n=e||t.length;const i=this.cursor,r=this.limit_backward;let a=0,o=0,u=!1;for(;;){const e=s+(n-s>>1);let h=0,g=a<o?a:o;var c;for(c=(l=t[e]).s_size-1-g;c>=0;c--){if(i-g==r){h=-1;break}if(h=this.current.charCodeAt(i-1-g)-l.s.charCodeAt(c),0!=h)break;g++}if(h<0?(n=e,o=g):(s=e,a=g),n-s<=1){if(s>0)break;if(n==s)break;if(u)break;u=!0}}for(;;){var l;if(a>=(l=t[s]).s_size){if(this.cursor=i-l.s_size,null==l.method)return l.result;const t=l.method(this);if(this.cursor=i-l.s_size,t)return l.result}if(s=l.substring_i,s<0)return 0}return-1}replace_s(t,e,s){const n=s.length-(e-t);return this.current=this.current.slice(0,t)+s+this.current.slice(e),this.limit+=n,this.cursor>=e?this.cursor+=n:this.cursor>t&&(this.cursor=t),n}slice_check(){return!(this.bra<0||this.bra>this.ket||this.ket>this.limit||this.limit>this.current.length)}slice_from(t){return!!this.slice_check()&&(this.replace_s(this.bra,this.ket,t),!0)}slice_del(){return this.slice_from("")}insert(t,e,s){const n=this.replace_s(t,e,s);t<=this.bra&&(this.bra+=n),t<=this.ket&&(this.ket+=n)}slice_to(t){let e="";return this.slice_check()&&(e=this.current.slice(this.bra,this.ket)),e}stemWord(t){let e=this.cache["."+t];return null==e&&(this.dictionary.before[t]?e=this.dictionary.before[t]:(this.setCurrent(t),this.innerStem(),e=this.getCurrent(),this.dictionary.after[e]&&(e=this.dictionary.after[e])),this.cache["."+t]=e),e}stemWords(t){const e=[];for(let s=0;s<t.length;s++){const n=this.stemWord(t[s]);n&&e.push(n.trim())}return e}stem(t){return null==t?t:Array.isArray(t)?this.stemWords(t):this.stemWords([t])[0]}getTokenizer(){return this.tokenizer||(this.tokenizer=this.container.get("tokenizer-"+this.name.slice(-2))||new pe),this.tokenizer}getStopwords(){return this.stopwords||(this.stopwords=this.container.get("tokenizer-"+this.name.slice(-2))),this.stopwords}tokenizeAndStem(t,e=!0){let s=this.getTokenizer().tokenize(t,!0);if(!e){const t=this.getStopwords();t&&(s=t.removeStopwords(s))}return this.stemWords(s)}};const{defaultContainer:ye}=oe;class De{constructor(t=ye){this.container=t.container||t,this.name="objToArr"}static objToArr(t){return Object.keys(t)}run(t){return t.tokens?(t.tokens=De.objToArr(t.tokens),t):De.objToArr(t)}}var we=De;const{defaultContainer:ve}=oe;var Ae=class{constructor(t=ve){this.container=t.container||t,this.name="stem"}stem(t){return t}getStemmer(t){const e=t,s=(e.locale||e.settings)&&e.settings.locale||"en";let n=this.container.get("stemmer-"+s);if(!n){const t=this.container.get("stemmer-bert");n=t&&t.activeFor(s)?t:this}return n}async addForTraining(t){const e=this.getStemmer(t);return e.addUtterance&&await e.addUtterance(t.utterance,t.intent),t}async train(t){const e=this.getStemmer(t);return e.innerTrain&&await e.innerTrain(),t}async run(t){const e=t,s=this.getStemmer(e);return e.tokens=await s.stem(e.tokens,e),e}};const{defaultContainer:Ce}=oe;var xe=class{constructor(t=Ce){this.container=t.container||t,this.name="removeStopwords",this.dictionary={}}build(t){for(let e=0;e<t.length;e+=1)this.dictionary[t[e]]=!0}isNotStopword(t){return!this.dictionary[t]}isStopword(t){return!!this.dictionary[t]}removeStopwords(t){return t.filter((t=>this.isNotStopword(t)))}run(t){if(t.settings&&!1===t.settings.keepStopwords){const e=t,s=e.locale||"en",n=this.container.get("stopwords-"+s)||this;return e.tokens=n.removeStopwords(e.tokens,e).filter((t=>t)),e}return t}};const{defaultContainer:be}=oe;var Fe=class{constructor(t=be){this.container=t.container||t,this.name="timer"}start(t){return t&&(t.hrstart=new Date),t}stop(t){const e=t;if(e&&e.hrstart){const t=new Date;e.elapsed=t.getTime()-e.hrstart.getTime(),delete e.hrstart}return e}run(t){this.start(t)}};const{defaultContainer:Ee}=oe;var ke=class{constructor(t={},e=Ee){this.container=t.container||e,this.applySettings(this,t)}get logger(){return this.container.get("logger")}applySettings(t,e={}){const s=t||{};return Object.keys(e).forEach((t=>{void 0===s[t]&&(s[t]=e[t])})),s}toJSON(){const t=this.jsonExport||{},e={},s=Object.keys(this);for(let n=0;n<s.length;n+=1){const i=s[n];if("jsonExport"!==i&&"jsonImport"!==i&&"container"!==i&&!i.startsWith("pipeline")){const s=void 0===t[i]||t[i];if("function"==typeof s){const t=s.bind(this)(e,this,i,this[i]);t&&(e[i]=t)}else"boolean"==typeof s?s&&(e[i]=this[i],"settings"===i&&delete e[i].container):"string"==typeof s&&(e[s]=this[i])}}return e}fromJSON(t){const e=this.jsonImport||{},s=Object.keys(t);for(let n=0;n<s.length;n+=1){const i=s[n],r=void 0===e[i]||e[i];if("function"==typeof r){const e=r.bind(this)(this,t,i,t[i]);e&&(this[i]=e)}else"boolean"==typeof r?r&&(this[i]=t[i]):"string"==typeof r&&(this[r]=t[i])}}objToValues(t,e){const s=e||Object.keys(t),n=[];for(let e=0;e<s.length;e+=1)n.push(t[s[e]]);return n}valuesToObj(t,e){const s={};for(let n=0;n<t.length;n+=1)s[e[n]]=t[n];return s}getPipeline(t){return this.container.getPipeline(t)}async runPipeline(t,e){return this.container.runPipeline(e||this.pipeline,t,this)}use(t){this.container.use(t)}};const{defaultContainer:Be}=oe;var Se=class extends ke{constructor(t={},e){super({settings:{},container:t.container||e||Be},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{etag:1,memory:{}}),this.settings.tag||(this.settings.tag="storage"),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag))}read(t){return new Promise((e=>{const s={};Array.isArray(t)||(t=[t]),t.forEach((t=>{const e=this.settings.memory[t];e&&(s[t]=JSON.parse(e))})),e(s)}))}saveItem(t,e){const s={...e};return s.eTag=this.settings.etag.toString(),this.settings.etag+=1,this.settings.memory[t]=JSON.stringify(s),s}write(t){return new Promise(((e,s)=>{Object.keys(t).forEach((n=>{const i=t[n],r=this.settings.memory[n];if(!r||"*"===i.eTag)return e(this.saveItem(n,i));const a=JSON.parse(r);return i.eTag!==a.eTag?s(new Error(`Error writing "${n}" due to eTag conflict.`)):e(this.saveItem(n,i))}))}))}delete(t){return new Promise((e=>{t.forEach((t=>delete this.settings.memory[t])),e()}))}},Ne={readFile:function(){return new Promise((t=>{t(void 0)}))},writeFile:function(){return new Promise(((t,e)=>{e(new Error("File cannot be written in web"))}))},existsSync:function(){return!1},lstatSync:function(){},readFileSync:function(){},name:"fs"};const{Container:Te}=oe,{loadEnvFromJson:Oe}=ee;function Pe(t,e){if("string"==typeof t)return t.startsWith("$")?It.env[`${e}${t.slice(1)}`]||It.env[t.slice(1)]:t;if(Array.isArray(t))return t.map((t=>Pe(t,e)));if("object"==typeof t){const s=Object.keys(t),n={};for(let i=0;i<s.length;i+=1)n[s[i]]=Pe(t[s[i]],e);return n}return t}var Le=function(t,e,s,n,i,r){const a=t||{},o=s||new Te(n);o.parent=r,n||(o.register("fs",Ne),o.use(le),o.use(ge),o.use(we),o.use(Ae),o.use(xe),o.use(pe),o.use(Fe),o.use(ne),o.use(Se));const u=a;let c;if(a.env&&Oe(n,a.env),c=u,c=Pe(c,n?n+"_":""),c.settings){const t=Object.keys(c.settings);for(let e=0;e<t.length;e+=1)o.registerConfiguration(t[e],c.settings[t[e]],!0)}if(c.use)for(let t=0;t<c.use.length;t+=1){const e=c.use[t];Array.isArray(e)?o.register(e[0],e[1]):o.use(e)}if(c.terraform)for(let t=0;t<c.terraform.length;t+=1){const e=c.terraform[t],s=o.get(e.className);o.register(e.name,s,!0)}if(c.childs&&(o.childs=c.childs),i)for(let t=0;t<i.length;t+=1){const e=i[t];o.registerPipeline(e.tag,e.pipeline,e.overwrite)}return c.pipelines&&function(t,e){t.loadPipelinesFromString(e)}(o,c.pipelines),o},je=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return`${t()+t()}-${t()}-${t()}-${t()}-${t()}${t()}${t()}`},$e=new class{constructor(){this.containers={}}getContainer(t){return this.containers[t||"default"]}async createContainer(t,e,s,n,i,r){const a=void 0===s||s;if("string"!=typeof t&&(e=t,t=""),e||"default"!==t&&""!==t||(e="conf.json"),!this.containers[t]){const s=Le(e,a,void 0,n,r);s.name=t,this.containers[t]=s,s.dock=this,s.parent=i,await s.start(),s.childs&&await this.buildChilds(s)}return this.containers[t]}async buildChilds(t){if(t&&t.childs){const e=Object.keys(t.childs),s={};for(let n=0;n<e.length;n+=1){const i=t.childs[e[n]];i.isChild=!0,i.pathPipeline||(i.pathPipeline=e[n]+"_pipeline.md"),s[e[n]]=await this.createContainer(e[n],i,!1,e[n],t,t.childPipelines?t.childPipelines[e[n]]:void 0)}t.childs=s}}async terraform(t,e=!0){return await this.createContainer("default",t,e,"")}start(t,e=!0){return this.terraform(t,e)}};const{defaultContainer:Me}=oe;var Re=class extends ke{constructor(t={},e){super({settings:{},container:t.container||e||Me},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="context"),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag))}getStorage(){const t=this.container.get(this.settings.storageName||"storage");if(!t)throw new Error("Storage not found");return t}getContext(t){return this.getStorage().read(`${this.settings.tag}-${t}`)}setContext(t,e){const s={[t]:e};return this.getStorage().write(s)}async getContextValue(t,e){const s=await this.getContext(t);return s?s[e]:void 0}async setContextValue(t,e,s){let n=await this.getContext(t);return n||(n={}),n[e]=s,this.setContext(t,n)}};const{Container:Ie,defaultContainer:ze}=oe,{hasUnicode:_e,unicodeToArray:Je,asciiToArray:We,stringToArray:qe,compareWildcars:Ve,loadEnv:Ue}=ee;var Ke={Among:pt,ArrToObj:le,BaseStemmer:me,containerBootstrap:Le,Clonable:ke,Container:Ie,defaultContainer:ze,hasUnicode:_e,unicodeToArray:Je,asciiToArray:We,stringToArray:qe,compareWildcars:Ve,loadEnv:Ue,Normalizer:ge,ObjToArr:we,Stemmer:Ae,Stopwords:xe,Tokenizer:pe,Timer:Fe,logger:ne,MemoryStorage:Se,uuid:je,dock:$e,Context:Re,dockStart:async function(t,e){return await $e.start(t,e),$e}},Ge=Ke.containerBootstrap;const He=[],Qe=[];var Ze=function(t,e){t.length>e.length&&([t,e]=[e,t]);let s=t.length-1,n=e.length-1;for(;s>0&&t.charCodeAt(s)===e.charCodeAt(n);)s-=1,n-=1;s+=1,n+=1;let i,r,a,o,u=0;for(;u<s&&t.charCodeAt(u)===e.charCodeAt(u);)u+=1;if(s-=u,n-=u,0===s)return n;for(let e=0;e<s;e+=1)Qe[e]=t.charCodeAt(u+e),He[e]=e+1;let c=0;for(;c<n;){i=e.charCodeAt(u+c),a=c,c+=1,r=c;for(let t=0;t<s;t+=1)o=a+(i!==Qe[t])|0,a=He[t],He[t]=a>r?o>r?r+1:o:o>a?a+1:o,r=He[t]}return r},Xe=function(t,e,s=!1){return s&&(t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()),t===e?0:Ze(t,e)},Ye=class{constructor(t){this.container=t}getTokens(t,e="en"){if("string"==typeof t){const s=this.container&&this.container.get("tokenizer-"+e);return s?s.tokenize(t,!0):t.split(" ")}return t}termFreqMap(t,e){const s=this.getTokens(t,e),n={};return s.forEach((t=>{n[t]=(n[t]||0)+1})),n}addKeysToDict(t,e){Object.keys(t).forEach((t=>{e[t]=!0}))}termFreqMapToVector(t,e){const s=[];return Object.keys(e).forEach((e=>{s.push(t[e]||0)})),s}vecDotProduct(t,e){let s=0;for(let n=0;n<t.length;n+=1)s+=t[n]*e[n];return s}vecMagnitude(t){let e=0;for(let s=0;s<t.length;s+=1)e+=t[s]*t[s];return Math.sqrt(e)}cosineSimilarity(t,e){return this.vecDotProduct(t,e)/(this.vecMagnitude(t)*this.vecMagnitude(e))}similarity(t,e,s){if(t===e)return 1;const n=this.termFreqMap(t,s),i=this.termFreqMap(e,s);if(!Object.keys(n).length||!Object.keys(i).length)return 0;const r={};this.addKeysToDict(n,r),this.addKeysToDict(i,r);const a=this.termFreqMapToVector(n,r),o=this.termFreqMapToVector(i,r);return this.cosineSimilarity(a,o)}},ts=class{constructor(t){this.settings=t||{},this.minLength=this.settings.minLength||4,this.settings.features?this.setFeatures(this.settings.features):(this.features={},this.featuresByLength={})}setFeatures(t){this.features=t,this.featuresByLength={},this.featuresList=Object.keys(this.features);for(let t=0;t<this.featuresList.length;t+=1){const e=this.featuresList[t],{length:s}=e;this.featuresByLength[s]||(this.featuresByLength[s]=[]),this.featuresByLength[s].push(e)}}checkToken(t,e){if(this.features[t])return t;if(t.length<this.minLength)return t;let s,n=1/0;for(let i=t.length-e-1;i<t.length+e;i+=1){const r=this.featuresByLength[i+1];if(r)for(let i=0;i<r.length;i+=1){const a=r[i],o=Xe(t,a);if(o<=e)if(o<n)s=a,n=o;else if(o===n&&s){const e=Math.abs(s.length-t.length),i=Math.abs(a.length-t.length);(e>i||e===i&&this.features[a]>this.features[s])&&(s=a,n=o)}}}return s||t}check(t,e=1){if(!Array.isArray(t)){const s=Object.keys(t),n=this.check(s,e),i={};for(let e=0;e<n.length;e+=1)i[n[e]]=t[s[e]];return i}const s=[];for(let n=0;n<t.length;n+=1)s.push(this.checkToken(t[n],e));return s}},es={leven:Ze,CosineSimilarity:Ye,similarity:Xe,SpellCheck:ts},ss=class{constructor(t,e="input"){this.dict={},this.items=[],t&&this.buildFromData(t,e)}add(t){void 0===this.dict[t]&&(this.dict[t]=this.items.length,this.items.push(t))}buildFromData(t,e){for(let s=0;s<t.length;s+=1){const n=t[s][e],i=Object.keys(n);for(let t=0;t<i.length;t+=1)this.add(i[t])}}prepare(t){const e=Object.keys(t),s=[],n={};for(let i=0;i<e.length;i+=1){const r=e[i];void 0!==this.dict[r]&&(s.push(this.dict[r]),n[this.dict[r]]=t[r])}return{keys:s,data:n}}},ns=class{constructor(t,e){if(t){this.inputLookup=new ss,this.outputLookup=new ss;for(let e=0;e<t.length;e+=1)this.inputLookup.add(t[e]);for(let t=0;t<e.length;t+=1)this.outputLookup.add(e[t]);this.numInputs=this.inputLookup.items.length,this.numOutputs=this.outputLookup.items.length}}build(t){this.inputLookup=new ss(t,"input"),this.outputLookup=new ss(t,"output"),this.numInputs=this.inputLookup.items.length,this.numOutputs=this.outputLookup.items.length;const e=[];for(let s=0;s<t.length;s+=1){const{input:n,output:i}=t[s];e.push({input:this.inputLookup.prepare(n),output:this.outputLookup.prepare(i)})}return e}transformInput(t){return this.inputLookup.prepare(t)}};const is={iterations:2e4,errorThresh:5e-5,deltaErrorThresh:1e-6,learningRate:.6,momentum:.5,alpha:.07,log:!1};var rs={NeuralNetwork:class{constructor(t={}){this.settings=t,this.applySettings(this.settings,is),!0===this.settings.log?this.logFn=(t,e)=>console.log(`Epoch ${t.iterations} loss ${t.error} time ${e}ms`):"function"==typeof this.settings.log&&(this.logFn=this.settings.log)}applySettings(t={},e={}){return Object.keys(e).forEach((s=>{void 0===t[s]&&(t[s]=e[s])})),t}initialize(t,e){this.perceptronsByName={},this.perceptrons=[],this.outputs={},this.numPerceptrons=e.length;for(let s=0;s<e.length;s+=1){const n=e[s];this.outputs[n]=0;const i={name:n,id:s,weights:new Float32Array(t),changes:new Float32Array(t),bias:0};this.perceptrons.push(i),this.perceptronsByName[n]=i}}runInputPerceptron(t,e){const s=e.keys.reduce(((s,n)=>s+e.data[n]*t.weights[n]),t.bias);return s<=0?0:this.settings.alpha*s}runInput(t){for(let e=0;e<this.numPerceptrons;e+=1)this.outputs[this.perceptrons[e].name]=this.runInputPerceptron(this.perceptrons[e],t);return this.outputs}get isRunnable(){return!!this.numPerceptrons}run(t){return this.numPerceptrons?this.runInput(this.lookup.transformInput(t)):void 0}prepareCorpus(t){return this.lookup=new ns,this.lookup.build(t)}verifyIsInitialized(){this.perceptrons||this.initialize(this.lookup.numInputs,this.lookup.outputLookup.items)}trainPerceptron(t,e){const{alpha:s,momentum:n}=this.settings,{changes:i,weights:r}=t;let a=0;for(let o=0;o<e.length;o+=1){const{input:u,output:c}=e[o],l=this.runInputPerceptron(t,u),h=(c.data[t.id]||0)-l;if(h){a+=h**2;const e=(l>0?1:s)*h*this.decayLearningRate;for(let t=0;t<u.keys.length;t+=1){const s=u.keys[t],a=e*u.data[s]+n*i[s];i[s]=a,r[s]+=a}t.bias+=e}}return a}train(t){if(!t||!t.length)return{};if(void 0!==t[t.length-1].input.nonefeature){const e={};for(let s=0;s<t.length-1;s+=1){const n=Object.keys(t[s].output);for(let t=0;t<n.length;t+=1)e[n[t]]||(e[n[t]]=1)}const s=t[t.length-1],n=Object.keys(e);for(let t=0;t<n.length;t+=1)s.output[n[t]]=1e-7}const e=this.prepareCorpus(t);this.status||(this.status={error:1/0,deltaError:1/0,iterations:0}),this.verifyIsInitialized();const s=this.settings.errorThresh,n=this.settings.deltaErrorThresh;for(;this.status.iterations<this.settings.iterations&&this.status.error>s&&this.status.deltaError>n;){const t=new Date;this.status.iterations+=1,this.decayLearningRate=this.settings.learningRate/(1+.001*this.status.iterations);const s=this.status.error;this.status.error=0;for(let t=0;t<this.numPerceptrons;t+=1)this.status.error+=this.trainPerceptron(this.perceptrons[t],e);this.status.error/=this.numPerceptrons*e.length,this.status.deltaError=Math.abs(this.status.error-s);const n=new Date;this.logFn&&this.logFn(this.status,n.getTime()-t.getTime())}return this.status}explain(t,e){const s=this.lookup.transformInput(t),n={},i=this.lookup.outputLookup.dict[e];if(void 0===i)return{};for(let t=0;t<s.keys.length;t+=1){const e=s.keys[t];n[this.lookup.inputLookup.items[e]]=this.perceptrons[i].weights[e]}return{weights:n,bias:this.perceptrons[i].bias}}toJSON(){const t={},e=Object.keys(this.settings);for(let s=0;s<e.length;s+=1){const n=e[s];this.settings[n]!==is[n]&&(t[n]=this.settings[n])}if(!this.lookup)return{settings:t};const s=this.lookup.inputLookup.items,n=this.lookup.outputLookup.items,i=[];for(let t=0;t<this.perceptrons.length;t+=1){const e=this.perceptrons[t],s=[...e.weights,e.bias];i.push(s)}return{settings:t,features:s,intents:n,perceptrons:i}}fromJSON(t){if(this.settings=this.applySettings({...is,...t.settings}),t.features){this.lookup=new ns(t.features,t.intents),this.initialize(t.features.length,t.intents);for(let e=0;e<this.perceptrons.length;e+=1){const s=this.perceptrons[e],n=t.perceptrons[e];s.bias=n[n.length-1];for(let e=0;e<t.features.length;e+=1)s.weights[e]=n[e]}}}}},as=[["ar","arb","Arabic"],["bn","ben","Bengali"],["ca","cat","Catalan"],["cs","ces","Czech"],["da","dan","Danish"],["de","deu","German"],["el","ell","Greek"],["en","eng","English"],["eu","eus","Basque"],["fa","fas","Persian"],["fi","fin","Finnish"],["fr","fra","French"],["ga","gle","Irish"],["gl","glg","Galician"],["hi","hin","Hindi"],["hu","hun","Hungarian"],["hy","hye","Armenian"],["id","ind","Indonesian"],["it","ita","Italian"],["ja","jpn","Japanese"],["ko","kor","Korean"],["lt","lit","Lithuanian"],["ne","nep","Nepali"],["nl","nld","Dutch"],["no","nor","Norwegian"],["pl","pol","Polish"],["pt","por","Portuguese"],["ro","ron","Romanian"],["ru","rus","Russian"],["sr","srp","Serbian"],["sl","slv","Slovenian"],["es","spa","Spanish"],["sv","swe","Swedish"],["ta","tam","Tamil"],["tl","tgl","Tagalog"],["th","tha","Thai"],["tr","tur","Turkish"],["uk","ukr","Ukrainian"],["zh","cmn","Chinese"]],os={Latin:{spa:"",eng:"",por:"",ind:"",fra:"",deu:"",ita:"",tur:"",nld:"",tgl:"",hun:"",ces:"",swe:"",fin:"",dan:"",cat:"",glg:"",slv:""},Cyrillic:{rus:"",ukr:""},Arabic:{arb:"",fas:""},Devanagari:{hin:""},Ethiopic:{},Hebrew:{}};const us={cmn:/[\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3038-\u303B\u3400-\u4DB5\u4E00-\u9FCC\uF900-\uFA6D\uFA70-\uFAD9]|[\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]/g,Latin:/[A-Za-z\xAA\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u02E0-\u02E4\u1D00-\u1D25\u1D2C-\u1D5C\u1D62-\u1D65\u1D6B-\u1D77\u1D79-\u1DBE\u1E00-\u1EFF\u2071\u207F\u2090-\u209C\u212A\u212B\u2132\u214E\u2160-\u2188\u2C60-\u2C7F\uA722-\uA787\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA7FF\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uFB00-\uFB06\uFF21-\uFF3A\uFF41-\uFF5A]/g,Cyrillic:/[\u0400-\u0484\u0487-\u052F\u1D2B\u1D78\u2DE0-\u2DFF\uA640-\uA69D\uA69F]/g,Arabic:/[\u0600-\u0604\u0606-\u060B\u060D-\u061A\u061E\u0620-\u063F\u0641-\u064A\u0656-\u065F\u066A-\u066F\u0671-\u06DC\u06DE-\u06FF\u0750-\u077F\u08A0-\u08B2\u08E4-\u08FF\uFB50-\uFBC1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFD\uFE70-\uFE74\uFE76-\uFEFC]|\uD803[\uDE60-\uDE7E]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB\uDEF0\uDEF1]/g,ben:/[\u0980-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09FB]/g,Devanagari:/[\u0900-\u0950\u0953-\u0963\u0966-\u097F\uA8E0-\uA8FB]/g,jpn:/[\u3041-\u3096\u309D-\u309F]|\uD82C\uDC01|\uD83C\uDE00|[\u30A1-\u30FA\u30FD-\u30FF\u31F0-\u31FF\u32D0-\u32FE\u3300-\u3357\uFF66-\uFF6F\uFF71-\uFF9D]|\uD82C\uDC00/g,kor:/[\u1100-\u11FF\u302E\u302F\u3131-\u318E\u3200-\u321E\u3260-\u327E\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/g,tel:/[\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C78-\u0C7F]/g,tam:/[\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BFA]/g,guj:/[\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AF1]/g,kan:/[\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2]/g,mal:/[\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D75\u0D79-\u0D7F]/g,Myanmar:/[\u1000-\u109F\uA9E0-\uA9FE\uAA60-\uAA7F]/g,ori:/[\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B77]/g,pan:/[\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75]/g,Ethiopic:/[\u1200-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u137C\u1380-\u1399\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E]/g,tha:/[\u0E01-\u0E3A\u0E40-\u0E5B]/g,sin:/[\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2-\u0DF4]|\uD804[\uDDE1-\uDDF4]/g,ell:/[\u0370-\u0373\u0375-\u0377\u037A-\u037D\u037F\u0384\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03E1\u03F0-\u03FF\u1D26-\u1D2A\u1D5D-\u1D61\u1D66-\u1D6A\u1DBF\u1F00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FC4\u1FC6-\u1FD3\u1FD6-\u1FDB\u1FDD-\u1FEF\u1FF2-\u1FF4\u1FF6-\u1FFE\u2126\uAB65]|\uD800[\uDD40-\uDD8C\uDDA0]|\uD834[\uDE00-\uDE45]/g,khm:/[\u1780-\u17DD\u17E0-\u17E9\u17F0-\u17F9\u19E0-\u19FF]/g,hye:/[\u0531-\u0556\u0559-\u055F\u0561-\u0587\u058A\u058D-\u058F\uFB13-\uFB17]/g,sat:/[\u1C50-\u1C7F]/g,bod:/[\u0F00-\u0F47\u0F49-\u0F6C\u0F71-\u0F97\u0F99-\u0FBC\u0FBE-\u0FCC\u0FCE-\u0FD4\u0FD9\u0FDA]/g,Hebrew:/[\u0591-\u05C7\u05D0-\u05EA\u05F0-\u05F4\uFB1D-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFB4F]/g,kat:/[\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u10FF\u2D00-\u2D25\u2D27\u2D2D]/g,lao:/[\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF]/g,zgh:/[\u2D30-\u2D67\u2D6F\u2D70\u2D7F]/g,iii:/[\uA000-\uA48C\uA490-\uA4C6]/g,aii:/[\u0700-\u070D\u070F-\u074A\u074D-\u074F]/g},cs=Object.keys(us);class ls{constructor(){this.languagesAlpha3={},this.languagesAlpha2={},this.extraSentences=[],this.buildData()}static getTrigrams(t){const e=[],s=t?` ${String(t).replace(/[\u0021-\u0040]+/g," ").replace(/\s+/g," ").trim().toLowerCase()} `:"";if(!s||s.length<3)return e;for(let t=0,n=s.length-2;t<n;t+=1)e[t]=s.substr(t,3);return e}static asTuples(t){const e=ls.getTrigrams(t).reduce(((t,e)=>{const s=t;return s[e]=(s[e]||0)+1,s}),{}),s=[];return Object.keys(e).forEach((t=>{s.push([t,e[t]])})),s.sort(((t,e)=>t[1]-e[1])),s}static getDistance(t,e){let s=0;return t.forEach((t=>{s+=t[0]in e?Math.abs(t[1]-e[t[0]]-1):300})),s}static getOccurrence(t,e){const s=t.match(e);return(s?s.length:0)/t.length||0}static isLatin(t){let e=0;const s=t.length/2;for(let n=0;n<t.length;n+=1){const i=t.charCodeAt(n);if(i>=32&&i<=126&&(e+=1,e>s))return!0}return e>s}static getTopScript(t){if(ls.isLatin(t))return["Latin",1];let e,s=-1;for(let n=0;n<cs.length;n+=1){const i=cs[n],r=ls.getOccurrence(t,us[i]);if(r>s&&(s=r,e=i,1===s))return[e,s]}return[e,s]}static filterLanguages(t,e,s){if(0===e.length&&0===s.length)return t;const n={};return Object.keys(t).forEach((i=>{(0===e.length||e.indexOf(i)>-1)&&-1===s.indexOf(i)&&(n[i]=t[i])})),n}static getDistances(t,e,s){const n=[],i=s.allowList||[],r=s.denyList||[],a=ls.filterLanguages(e,i,r);return a?(Object.keys(a).forEach((e=>{n.push([e,ls.getDistance(t,a[e])])})),n.sort(((t,e)=>t[1]-e[1]))):[["und",1]]}static detectAll(t,e={}){const s=e.minLength||10;if(!t||t.length<s)return[["und",1]];const n=t.substr(0,2048),i=ls.getTopScript(n);if(!(i[0]in os)&&i[1]>.5){if(!e.allowList)return[[i[0],1]];if(e.allowList.includes(i[0]))return[[i[0],1]];if("cmn"===i[0]&&e.allowList.includes("jpn"))return[["jpn",1]]}if(os[i[0]]){const t=ls.getDistances(ls.asTuples(n),os[i[0]],e);if("und"===t[0][0])return[[i[0],1]];const s=t[0][1],r=300*n.length-s;return t.map((t=>[t[0],1-(t[1]-s)/r||0]))}return[[i[0],1]]}buildData(){for(let t=0;t<as.length;t+=1){const e={alpha2:as[t][0],alpha3:as[t][1],name:as[t][2]};this.languagesAlpha3[e.alpha3]=e,this.languagesAlpha2[e.alpha2]=e}}transformAllowList(t){const e=[];for(let s=0;s<t.length;s+=1)if(3===t[s].length)e.push(t[s]);else{const n=this.languagesAlpha2[t[s]];n&&e.push(n.alpha3)}return e}guess(t,e,s){const n={};t.length<10&&(n.minLength=t.length),e&&e.length&&e.length>0&&(n.allowList=this.transformAllowList(e));const i=ls.detectAll(t,n),r=[];for(let t=0;t<i.length;t+=1){const e=this.languagesAlpha3[i[t][0]];if(e&&(r.push({alpha3:e.alpha3,alpha2:e.alpha2,language:e.name,score:i[t][1]}),s&&r.length>=s))break}return r}guessBest(t,e){return this.guess(t,e,1)[0]}addTrigrams(t,e){const s=this.languagesAlpha2[t],n=s?s.alpha3:t,i=ls.getTopScript(e)[0],r=ls.getTrigrams(e);os[i]&&(os[i][n]||(os[i][n]={}),r.forEach((t=>{os[i][n][t]=1})))}addExtraSentence(t,e){this.extraSentences.push([t,e]),this.addTrigrams(t,e)}processExtraSentences(){this.extraSentences.forEach((t=>{this.addTrigrams(t[0],t[1])}))}static lansplit(t){if(t.includes("|"))return t.split("|");const e=[];for(let s=0;s<t.length;s+=3)e.push(t.substr(s,3));return e}static addModel(t,e,s){const n=os[t],i=ls.lansplit(s);let r=i.length;const a={};for(;r>0;)r-=1,a[i[r]]=r;n[e]=a}addModel(t,e,s){ls.addModel(t,e,s)}static buildModel(){Object.keys(os).forEach((t=>{const e=os[t];Object.keys(e).forEach((s=>{ls.addModel(t,s,e[s])}))}))}}ls.buildModel();var hs={Language:ls};const{Clonable:gs,compareWildcars:ds}=Ke,{SpellCheck:ps}=es;var fs=class extends gs{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{locale:"en"}),this.settings.tag||(this.settings.tag="nlu-"+this.settings.locale),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.applySettings(this,{pipelinePrepare:this.getPipeline(this.settings.tag+"-prepare"),pipelineTrain:this.getPipeline(this.settings.tag+"-train"),pipelineProcess:this.getPipeline(this.settings.tag+"-process")}),this.spellCheck=new ps}registerDefault(){this.container.registerConfiguration("nlu-??",{keepStopwords:!0,nonefeatureValue:1,nonedeltaMultiplier:1.2,spellCheck:!1,spellCheckDistance:1,filterZeros:!0,log:!0},!1),this.container.registerPipeline("nlu-??-train",[".prepareCorpus",".addNoneFeature",".innerTrain"],!1)}async defaultPipelinePrepare(t){let e;if(this.cache){const t=new Date;Math.abs(t.getTime()-this.cache.created)/36e5>1&&(this.cache.results={},this.cache.created=(new Date).getTime())}if(this.cache){if(this.cache.results[t.settings.locale]&&(e=this.cache.results[t.settings.locale][t.text||t.utterance],e))return e}else this.cache={created:(new Date).getTime(),results:{},normalize:this.container.get("normalize"),tokenize:this.container.get("tokenize"),removeStopwords:this.container.get("removeStopwords"),stem:this.container.get("stem"),arrToObj:this.container.get("arrToObj")};let s=t;return s=this.cache.normalize.run(s),s=await this.cache.tokenize.run(s),s=this.cache.removeStopwords.run(s),s=await this.cache.stem.run(s),s=this.cache.arrToObj.run(s),e=s.tokens,this.cache.results[t.settings.locale]||(this.cache.results[t.settings.locale]={}),this.cache.results[t.settings.locale][t.text||t.utterance]=e,e}async defaultPipelineProcess(t){let e=await this.prepare(t);return e=await this.doSpellCheck(e),e=await this.textToFeatures(e),e=await this.innerProcess(e),e=await this.filterNonActivated(e),e=await this.normalizeClassifications(e),e}async prepare(t,e){const s=e||this.settings;if("string"==typeof t){const e={locale:this.settings.locale,text:t,settings:s};return this.pipelinePrepare?this.runPipeline(e,this.pipelinePrepare):this.defaultPipelinePrepare(e)}if("object"==typeof t){if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n+=1)e.push(await this.prepare(t[n],s));return e}const e=s.fieldNameSrc?t[s.fieldNameSrc]:t.text||t.utterance||t.texts||t.utterances;if(e){const n=await this.prepare(e,s);return{[s.fieldNameTgt||"tokens"]:n,...t}}}throw new Error("Error at nlu.prepare: expected a text but received "+t)}async doSpellCheck(t,e){const s=this.applySettings(e||{},this.settings);let n=void 0===t.settings.spellCheck?void 0:t.settings.spellCheck,i=void 0===t.settings.spellCheckDistance?void 0:t.settings.spellCheckDistance;if(void 0===n&&(n=void 0===s.spellCheck?void 0:s.spellCheck),void 0===i&&(i=void 0===s.spellCheckDistance?1:s.spellCheckDistance),n){const e=this.spellCheck.check(t.tokens,i);t.tokens=e}return t}async prepareCorpus(t){this.features={},this.intents={},this.intentFeatures={};const e=t,{corpus:s}=e,n=[];for(let t=0;t<s.length;t+=1){const{intent:i}=s[t],r={input:await this.prepare(s[t].utterance,e.settings),output:{[i]:1}},a=Object.keys(r.input);this.intentFeatures[i]||(this.intentFeatures[i]={});for(let t=0;t<a.length;t+=1)this.features[a[t]]=1,this.intentFeatures[i][a[t]]=1;this.intents[i]=1,n.push(r)}const i=Object.keys(this.intentFeatures);this.featuresToIntent={};for(let t=0;t<i.length;t+=1){const e=i[t],s=Object.keys(this.intentFeatures[e]);for(let t=0;t<s.length;t+=1){const n=s[t];this.featuresToIntent[n]||(this.featuresToIntent[n]=[]),this.featuresToIntent[n].push(e)}}return this.spellCheck.setFeatures(this.features),this.numFeatures=Object.keys(this.features).length,this.numIntents=Object.keys(this.intents).length,e.corpus=n,e}addNoneFeature(t){const{corpus:e}=t;return t.settings&&t.settings.useNoneFeature&&e.push({input:{nonefeature:1},output:{None:1}}),t}convertToArray(t){const e=t,{classifications:s}=e;if(s){this.intentsArr||(this.intents?(this.intentsArr=Object.keys(this.intents),this.intents.None||this.intentsArr.push("None")):this.intentsArr=Object.keys(s));const t=this.intentsArr,n=[];for(let i=0;i<t.length;i+=1){const r=t[i],a=s[r];void 0!==a&&(a>0||!e.settings.filterZeros)&&n.push({intent:r,score:a})}n.length||n.push({intent:"None",score:1}),e.classifications=n.sort(((t,e)=>e.score-t.score))}return e}someSimilar(t,e){for(let s=0;s<e.length;s+=1)if(t[e[s]])return!0;return!1}matchAllowList(t,e){for(let s=0;s<e.length;s+=1)if(ds(t,e[s]))return!0;return!1}intentIsActivated(t,e,s){if(s){if(Array.isArray(s))return this.matchAllowList(t,s);if(!s[t])return!1}const n=this.intentFeatures[t];if(!n)return!1;const i=Object.keys(e);for(let t=0;t<i.length;t+=1)if(n[i[t]])return!0;return!1}filterNonActivated(t){if(this.intentFeatures&&t.classifications){const e=t.classifications.map((t=>t.intent));let s=!1;for(let n=0;n<e.length;n+=1){const i=e[n];"None"!==i&&(this.intentIsActivated(i,t.tokens,t.settings.allowList)||(t.classifications[n].score=0,s=!0))}s&&t.classifications.sort(((t,e)=>e.score-t.score))}return t}normalizeClassifications(t){const e=t,{classifications:s}=e;if(s){let t=0;for(let e=0;e<s.length;e+=1)s[e].score**=2,t+=s[e].score;if(t>0)for(let e=0;e<s.length;e+=1)s[e].score/=t}else e.classifications=e.nluAnswer;return e}textToFeatures(t){const e=t,{tokens:s}=e,n=Object.keys(s);let i=0;const r={};for(let t=0;t<n.length;t+=1){const e=n[t];"nonefeature"===e?s[e]=this.nonefeatureValue:this.features&&this.features[e]?r[e]=s[e]:i+=1}let a=void 0===e.settings.nonedeltaValue?this.numIntents/this.numFeatures:this.settings.nonedeltaValue,o=0;for(let t=0;t<i;t+=1)o+=a,a*=this.settings.nonedeltaMultiplier;return e.settings&&e.settings.useNoneFeature&&o&&(r.nonefeature=o),e.tokens=r,e}async innerTrain(){throw new Error("This method should be implemented by child classes")}async train(t,e){const s={corpus:t,settings:this.applySettings(e,this.settings)};return this.runPipeline(s,this.pipelineTrain)}async getExplanation(t,e){if(!e)return;const s=await this.container.get("normalize").run(t),n=await this.container.get("tokenize").run(s),{tokens:i}=n,r=(await this.container.get("stem").run(n)).tokens,a=[];a.push({token:"",stem:"##bias",weight:e.bias});for(let t=0;t<i.length;t+=1){const s=r[t];a.push({token:i[t],stem:s,weight:e.weights[s]})}return a}async process(t,e){const s={text:t,settings:this.applySettings(e||{},this.settings)};let n;if(n=this.pipelineProcess?await this.runPipeline(s,this.pipelineProcess):await this.defaultPipelineProcess(s),Array.isArray(n.classifications)){const t=s.settings.returnExplanation?await this.getExplanation(s,n.explanation):void 0;return{classifications:n.classifications,entities:void 0,explanation:t}}return n.intents&&(n.classifications=n.intents,delete n.intents),n}toJSON(){const t={settings:{...this.settings},features:this.features,intents:this.intents,intentFeatures:this.intentFeatures,featuresToIntent:this.featuresToIntent};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.features=t.features||{},this.intents=t.intents||{},this.featuresToIntent=t.featuresToIntent||{},this.intentFeatures=t.intentFeatures||{},this.spellCheck.setFeatures(this.features),this.numFeatures=Object.keys(this.features).length,this.numIntents=Object.keys(this.intents).length}};const{NeuralNetwork:ms}=rs;class ys extends fs{async innerTrain(t){const e=t;return this.neuralNetwork=new ms(e.settings,this.container),e.status=await this.neuralNetwork.train(e.corpus),e}innerProcess(t){const e=t;e.classifications=this.neuralNetwork&&this.neuralNetwork.run(e.tokens)||{None:1},this.convertToArray(e);const{intent:s}=e.classifications[0];return e.settings&&e.settings.returnExplanation&&s&&this.neuralNetwork&&"None"!==s&&(e.explanation=this.neuralNetwork.explain(e.tokens,s)),e}registerDefault(){super.registerDefault(),this.container.register("NeuralNlu",ys,!1)}toJSON(){const t=super.toJSON();return t.neuralNetwork=this.neuralNetwork?this.neuralNetwork.toJSON():void 0,t}fromJSON(t){super.fromJSON(t),t.neuralNetwork&&(this.neuralNetwork=new ms,this.neuralNetwork.fromJSON(t.neuralNetwork))}}var Ds=ys;const{Clonable:ws,compareWildcars:vs}=Ke;var As=class extends ws{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{locale:"en"}),this.settings.tag||(this.settings.tag="domain-manager-"+this.settings.locale),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.domains={},this.addDomain("master_domain"),this.stemDict={},this.intentDict={},this.sentences=[],this.applySettings(this,{pipelineTrain:this.getPipeline(this.settings.tag+"-train"),pipelineProcess:this.getPipeline(this.settings.tag+"-process")})}registerDefault(){this.container.registerConfiguration("domain-manager-??",{nluByDomain:{default:{className:"NeuralNlu",settings:{}}},trainByDomain:!1,useStemDict:!0},!1),this.container.registerPipeline("domain-manager-??-train",[".trainStemmer",".generateCorpus",".fillStemDict",".innerTrain","output.status"],!1)}getDomainInstance(t){this.settings.nluByDomain||(this.settings.nluByDomain={});const e=this.settings.nluByDomain[t]||this.settings.nluByDomain.default||{className:"NeuralNlu",settings:{}};return this.container.get(e.className||"NeuralNlu",this.applySettings({locale:this.settings.locale},e.settings||{}))}addDomain(t){return this.domains[t]||(this.domains[t]=this.getDomainInstance(t)),this.domains[t]}removeDomain(t){delete this.domains[t]}async generateStemKey(t){let e;if("string"!=typeof t)e=t;else{const s=await this.prepare({utterance:t});e=await s.stems}return Array.isArray(e)||(e=Object.keys(e)),e.slice().sort().join()}add(t,e,s){s?this.sentences.push({domain:t,utterance:e,intent:s}):this.sentences.push({domain:"master_domain",utterance:t,intent:e})}remove(t,e,s){const n=s?t:"master_domain",i=s?e:t,r=s||e;for(let t=0;t<this.sentences.length;t+=1){const e=this.sentences[t];if(e.domain===n&&e.utterance===i&&e.intent===r)return this.sentences.splice(t,1),!0}return!1}async trainStemmer(t){const e=t;this.cache||(this.cache={stem:this.container.get("stem")});for(let t=0;t<this.sentences.length;t+=1){const s={...this.sentences[t],...e};await this.cache.stem.addForTraining(s)}return await this.cache.stem.train(e),e}innerGenerateCorpus(t){this.intentDict={};const e={master_domain:[]};for(let s=0;s<this.sentences.length;s+=1){const n=this.sentences[s];this.intentDict[n.intent]=n.domain;const i=t||n.domain;e[i]||(e[i]=[]),e[i].push({utterance:n.utterance,intent:n.intent}),t||e.master_domain.push({utterance:n.utterance,intent:n.domain})}return e}async generateCorpus(t){const e=t;return e.corpus=this.innerGenerateCorpus(this.settings.trainByDomain?void 0:"master_domain"),e}async prepare(t){const e=t,s="string"==typeof e,n=s?e:e.utterance,i=this.addDomain("master_domain").prepare(n);return s?i:(e.stems=i,e)}async fillStemDict(t){this.stemDict={};for(let t=0;t<this.sentences.length;t+=1){const e=await this.generateStemKey(this.sentences[t].utterance);this.stemDict[e]={intent:this.sentences[t].intent,domain:this.sentences[t].domain}}return t}async innerTrain(t){const e=t,{corpus:s}=e,n=Object.keys(s),i={};for(let e=0;e<n.length;e+=1){const r=this.addDomain(n[e]),a={useNoneFeature:this.settings.useNoneFeature};t.settings&&void 0!==t.settings.log&&(a.log=t.settings.log);const o=await r.train(s[n[e]],a);i[n[e]]=o.status}return e.status=i,e}async train(t){const e={domainManager:this,settings:t||this.settings};return this.runPipeline(e,this.pipelineTrain)}matchAllowList(t,e){for(let s=0;s<e.length;s+=1)if(vs(t,e[s]))return!0;return!1}async classifyByStemDict(t,e,s){const n=await this.generateStemKey(t),i=this.stemDict[n];if(i&&(!e||i.domain===e)){if(s&&!this.matchAllowList(i.intent,s))return;const t=[];t.push({intent:i.intent,score:1});const e=Object.keys(this.intentDict);for(let s=0;s<e.length;s+=1)e[s]!==i.intent&&t.push({intent:e[s],score:0});return{domain:i.domain,classifications:t}}}async innerClassify(t,e){const s=t;if(this.applySettings({...s.settings},this.settings).useStemDict){const n=await this.classifyByStemDict(s.utterance,e,t.settings?t.settings.allowList:void 0);if(n)return s.classification=n,s.explanation=[{token:"",stem:"##exact",weight:1}],s}if(e){const t=this.domains[e];if(!t)return s.classification={domain:"default",classifications:[{intent:"None",score:1}]},s;const n=await t.process(s.utterance,s.settings||this.settings);let i,r;return Array.isArray(n)?i=n:(i=n.classifications,s.nluAnswer=n),r="master_domain"===e?i&&i.length?this.intentDict[i[0].intent]:"master_domain":e,s.classification={domain:r,classifications:i},s}let n="master_domain";if(void 0===s.settings.trainByDomain&&this.settings.trainByDomain||s.settings.trainByDomain){const t=this.domains.master_domain;let e=await t.process(s.utterance);if(e.classifications&&(e=e.classifications),1===Object.keys(this.domains).length)return s.classification={domain:"default",classifications:e},s;if(n=e[0].intent,"None"===n)return s.classification={domain:"default",classifications:[{intent:"None",score:1}]},s}return this.innerClassify(s,n)}async defaultPipelineProcess(t){return(await this.innerClassify(t)).classification}async process(t,e){const s="string"==typeof t?{utterance:t,settings:e||this.settings}:t;return this.pipelineProcess?this.runPipeline(s,this.pipelineProcess):this.defaultPipelineProcess(s)}toJSON(){const t={settings:this.settings,stemDict:this.stemDict,intentDict:this.intentDict,sentences:this.sentences,domains:{}};delete t.settings.container;const e=Object.keys(this.domains);for(let s=0;s<e.length;s+=1)t.domains[e[s]]=this.domains[e[s]].toJSON();return t}fromJSON(t){this.applySettings(this.settings,t.settings),this.stemDict=t.stemDict,this.intentDict=t.intentDict,this.sentences=t.sentences;const e=Object.keys(t.domains);for(let s=0;s<e.length;s+=1)this.addDomain(e[s]).fromJSON(t.domains[e[s]])}};const{Clonable:Cs}=Ke,{Language:xs}=hs;var bs=class extends Cs{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlu-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.container.get("Language")||this.container.register("Language",xs,!1),this.guesser=this.container.get("Language"),this.locales=[],this.languageNames={},this.domainManagers={},this.intentDomains={},this.settings.locales&&this.addLanguage(this.settings.locales),this.applySettings(this,{pipelineTrain:this.getPipeline(this.settings.tag+"-train"),pipelineProcess:this.getPipeline(this.settings.tag+"-process")})}registerDefault(){this.container.registerConfiguration("nlu-manager",{},!1),this.container.registerPipeline("nlu-manager-train",[".innerTrain"],!1)}describeLanguage(t,e){this.languageNames[t]={locale:t,name:e}}addLanguage(t){if(t){const e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;t+=1){const s=e[t].substr(0,2).toLowerCase();this.locales.includes(s)||this.locales.push(s),this.domainManagers[s]||(this.domainManagers[s]=new As({locale:s,...this.settings.domain,useNoneFeature:this.settings.useNoneFeature,trainByDomain:this.settings.trainByDomain},this.container))}}}removeLanguage(t){if(Array.isArray(t))t.forEach((t=>this.removeLanguage(t)));else{delete this.domainManagers[t];const e=this.locales.indexOf(t);-1!==e&&this.locales.splice(e,1)}}guessLanguage(t){const e=t,s="string"==typeof e;if(1===this.locales.length)return s?this.locales[0]:([e.locale]=this.locales,e);if(!e)return s?void 0:e;if(!s&&e.locale)return e;const n=s?e:e.utterance;if(1===this.locales.length){if(s)return this.locales[0];[e.locale]=this.locales}const i=this.guesser.guess(n,this.locales,1),r=i&&i.length>0?i[0].alpha2:void 0;return s?r:(e.locale=r,e)}assignDomain(t,e,s){const n=s?t.substr(0,2).toLowerCase():void 0,i=s?e:t,r=s||e;if(n)this.intentDomains[n]||(this.intentDomains[n]={}),this.intentDomains[n][i]=r;else for(let t=0;t<this.locales.length;t+=1)this.assignDomain(this.locales[t],i,r)}getIntentDomain(t,e){const s=t.substr(0,2).toLowerCase();return this.intentDomains[s]&&this.intentDomains[s][e]||"default"}getDomains(){const t={},e=Object.keys(this.intentDomains);for(let s=0;s<e.length;s+=1){const n=e[s];t[n]={};const i=Object.keys(this.intentDomains[n]);for(let e=0;e<i.length;e+=1){const s=i[e],r=this.intentDomains[n][s];t[n][r]||(t[n][r]=[]),t[n][r].push(s)}}return t}consolidateLocale(t,e){const s=t?t.substr(0,2).toLowerCase():this.guessLanguage(e);if(!s)throw new Error("Locale must be defined");return s}consolidateManager(t){const e=this.domainManagers[t];if(!e)throw new Error("Domain Manager not found for locale "+t);return e}add(t,e,s){const n=this.consolidateLocale(t,e),i=this.consolidateManager(n),r=this.getIntentDomain(n,s);this.guesser.addExtraSentence(n,e),i.add(r,e,s)}remove(t,e,s){const n=this.consolidateLocale(t,e),i=this.consolidateManager(n),r=this.getIntentDomain(n,s);i.remove(r,e,s)}async innerTrain(t){let e=t.locales||this.locales;Array.isArray(e)||(e=[e]);const s=e.filter((t=>this.domainManagers[t])).map((e=>this.domainManagers[e].train(t.settings)));return Promise.all(s)}async train(t){const e={nluManager:this,settings:this.applySettings(t,this.settings)};return delete e.settings.tag,this.runPipeline(e,this.pipelineTrain)}fillLanguage(t){const e=t;return e.languageGuessed=!1,e.locale||(e.locale=this.guessLanguage(e.utterance),e.languageGuessed=!0),e.locale&&(e.localeIso2=e.locale.substr(0,2).toLowerCase(),e.language=(this.languageNames[e.localeIso2]||this.guesser.languagesAlpha2[e.localeIso2]||{}).name),e}classificationsIsNone(t){return 1!==t.length&&(0===t.length||0===t[0].score||t[0].score===t[1].score)}checkIfIsNone(t){const e=t;return this.classificationsIsNone(e.classifications)&&(e.intent="None",e.score=1),e}async innerClassify(t){const e=t,s=this.domainManagers[e.localeIso2];if(!s)return e.classifications=[],e.domain=void 0,e.intent=void 0,e.score=void 0,e;const n=await s.process(t);return e.classifications=n.classifications.sort(((t,e)=>e.score-t.score)),0===e.classifications.length&&e.classifications.push({intent:"None",score:1}),e.intent=e.classifications[0].intent,e.score=e.classifications[0].score,"None"===e.intent?n.domain="default":"default"===n.domain?e.domain=this.getIntentDomain(e.locale,e.intent):e.domain=n.domain,e}async defaultPipelineProcess(t){let e=await this.fillLanguage(t);return e=await this.innerClassify(e),e=await this.checkIfIsNone(e),delete e.settings,delete e.classification,e}process(t,e,s,n){const i="object"==typeof t?t:{locale:void 0===e?void 0:t,utterance:void 0===e?t:e,domain:s,settings:n||this.settings};return this.pipelineProcess?this.runPipeline(i,this.pipelineProcess):this.defaultPipelineProcess(i)}toJSON(){const t={settings:this.settings,locales:this.locales,languageNames:this.languageNames,domainManagers:{},intentDomains:this.intentDomains,extraSentences:this.guesser.extraSentences.slice(0)};delete t.settings.container;const e=Object.keys(this.domainManagers);for(let s=0;s<e.length;s+=1){const n=e[s];t.domainManagers[n]=this.domainManagers[n].toJSON()}return t}fromJSON(t){this.applySettings(this.settings,t.settings);for(let e=0;e<t.locales.length;e+=1)this.addLanguage(t.locales[e]);this.languageNames=t.languageNames,this.intentDomains=t.intentDomains;const e=Object.keys(t.domainManagers);for(let s=0;s<e.length;s+=1){const n=e[s];this.domainManagers[n].fromJSON(t.domainManagers[n])}for(let e=0;e<t.extraSentences.length;e+=1){const s=t.extraSentences[e];this.guesser.addExtraSentence(s[0],s[1])}}},Fs={Nlu:fs,NluNeural:Ds,DomainManager:As,NluManager:bs};function Es(t,e,s){let n,i;t.accuracy>e.accuracy||t.accuracy===e.accuracy&&t.length>e.length?(n=t,i=e):(n=e,i=t),i.start<=n.end&&i.end>=n.start&&(i.accuracy<n.accuracy?i.discarded=!0:(s||i.entity===n.entity||"number"===i.entity)&&i.len<=n.len?i.start===n.start&&i.end===n.end&&i.type===n.type&&i.entity===n.entity&&i.option===n.option&&(i.discarded=!0):(s||i.entity===n.entity||"number"===n.entity)&&i.len>n.len?n.discarded=!0:"enum"===n.type&&"enum"===i.type&&(n.len<=i.len&&i.utteranceText.includes(n.utteranceText)?n.discarded=!0:n.len>i.len&&n.utteranceText.includes(i.utteranceText)&&(i.discarded=!0)))}var ks=function(t,e=!0){const s=t.length;for(let n=0;n<s;n+=1){const i=t[n];if(!i.discarded)for(let r=n+1;r<s;r+=1){const s=t[r];s.discarded||Es(i,s,e)}}return t.filter((t=>!t.discarded))};const{defaultContainer:Bs}=Ke,{Language:Ss}=hs,{similarity:Ns}=es;var Ts=class{constructor(t=Bs){this.container=t.container||t,this.name="extract-enum"}getScripts(t){const e=[],s=t.split("");for(let t=0;t<s.length;t+=1)e.push(Ss.getTopScript(s[t]));return e}isAlphanumeric(t){return/[\u00C0-\u1FFF\u2C00-\uD7FF\w]/.test(t)&&"_"!==t}getWordPositions(t){const e=this.getScripts(t);let s=!0,n=0,i=0;const r=t.length,a=[];for(;i<r;)this.isAlphanumeric(t.charAt(i))?s&&("cmn"===e[i][0]?(a.push({start:i,end:i,len:1}),n=i):(n=i,s=!1)):s||(a.push({start:n,end:i-1,len:i-n}),s=!0),i+=1;return s||a.push({start:n,end:i-1,len:i-n}),a}getBestSubstring(t,e,s){const n=t.length,i=e.length;if(n<=i){const s={start:0,end:n-1,len:n,levenshtein:Ns(t,e,!0)};return s.accuracy=(i-s.levenshtein)/i,s}const r=s||this.getWordPositions(t),a=r.length,o={start:0,end:0,len:0,levenshtein:void 0,accuracy:0};for(let s=0;s<a;s+=1)for(let n=s;n<a;n+=1){const i=t.substring(r[s].start,r[n].end+1),a=Ns(i,e,!0);(void 0===o.levenshtein||a<o.levenshtein)&&(o.levenshtein=a,o.start=r[s].start,o.end=r[n].end,o.len=o.end-o.start+1)}return o.accuracy=(i-o.levenshtein)/i,o}getBestSubstringList(t,e,s,n=1){const i=t.length,r=e.length,a=[];if(i<=r){const s=Ns(t,e,!0),o=(r-s)/r;return o>=n&&a.push({start:0,end:i-1,len:i,levenshtein:s,accuracy:o}),a}const o=r*(1-n),u=s||this.getWordPositions(t),c=u.length;for(let s=0;s<c;s+=1)for(let i=s;i<c;i+=1){const c=t.substring(u[s].start,u[i].end+1),l=Ns(c,e,!0),h=(r-l)/r;if(h>=n&&a.push({start:u[s].start,end:u[i].end,len:u[i].end-u[s].start+1,levenshtein:l,accuracy:h}),c.length-u[0].len>=e.length+o)break}return a}getRules(t){return t.nerRules||[]}normalize(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}buildRuleDict(t){const e={},s={};for(let n=0;n<t.rules.length;n+=1){const i=t.rules[n];for(let t=0;t<i.texts.length;t+=1){const n=i.texts[t],r=this.normalize(i.texts[t]);e[r]||(e[r]=[]),e[r].push(i),s[r]=n}}t.dict=e,t.inverseDict=s}getBestExact(t,e,s){const n=this.normalize(t),i=e||this.getWordPositions(n),r=i.length,a=[];for(let e=0;e<r;e+=1)for(let o=e;o<r;o+=1){const r=n.substring(i[e].start,i[o].end+1);if(s.dict[r]){const n=s.dict[r];for(let u=0;u<n.length;u+=1)a.push({accuracy:1,start:i[e].start,end:i[o].end,len:i[o].end-i[e].start+1,levenshtein:0,entity:s.name,type:s.type,option:n[u].option,sourceText:s.inverseDict[r],utteranceText:t.substring(i[e].start,i[o].end+1)})}}return a}extractFromRule(t,e,s,n){if("enum"===e.type){const i=[];if(n>=1){e.dict||this.buildRuleDict(e);const n=this.getBestExact(t,s,e);for(let t=0;t<n.length;t+=1)i.push(n[t])}else for(let r=0;r<e.rules.length;r+=1){const a=e.rules[r];if(a&&a.option&&Array.isArray(a.texts))for(let o=0;o<a.texts.length;o+=1){const u=this.getBestSubstringList(t,a.texts[o],s,a.threshold||n);for(let s=0;s<u.length;s+=1)i.push({...u[s],entity:e.name,type:e.type,option:e.rules[r].option,sourceText:a.texts[o],utteranceText:t.substring(u[s].start,u[s].end+1)})}}return i}return[]}extract(t){const e=t,s=this.getWordPositions(e.text||e.utterance),n=this.getRules(e),i=e.edges||[];for(let t=0;t<n.length;t+=1){const r=this.extractFromRule(e.text||e.utterance,n[t],s,e.threshold||.8);for(let t=0;t<r.length;t+=1)i.push(r[t])}return i.sort(((t,e)=>t.start-e.start)),e.edges=ks(i,!1),e}run(t){const e=t,s=e.locale||"en";return(this.container.get("extract-enum-"+s)||this).extract(e)}};const{defaultContainer:Os}=Ke;var Ps=class{constructor(t=Os){this.container=t.container||t,this.name="extract-regex"}getRules(t){return t.nerRules||[]}getMatchs(t,e){const s=[];let n;do{const i=e instanceof RegExp?e.exec(t):null;i?(s.push({start:i.index,end:e.lastIndex-1,accuracy:1,sourceText:i[0]}),n=!0):n=!1}while(n);return s}extractFromRule(t,e){const s=[];for(let n=0;n<e.rules.length;n+=1){const i=this.getMatchs(t,e.rules[n]);for(let n=0;n<i.length;n+=1){const r=i[n];r.entity=e.name,r.type=e.type,r.utteranceText=t.substring(r.start,r.end+1),r.len=r.utteranceText.length,s.push(r)}}return s}extract(t){const e=t,s=this.getRules(e),n=e.edges||[];for(let t=0;t<s.length;t+=1){const i=this.extractFromRule(e.text||e.utterance,s[t]);for(let t=0;t<i.length;t+=1)n.push(i[t])}return n.sort(((t,e)=>t.start-e.start)),e.edges=ks(n,!1),e}run(t){const e=t,s=e.locale||"en";return(this.container.get("extract-regex-"+s)||this).extract(e)}};const Ls={Between:"between",After:"after",AfterLast:"afterLast",AfterFirst:"afterFirst",Before:"before",BeforeFirst:"beforeFirst",BeforeLast:"beforeLast"};var js={TrimType:Ls,TrimTypesList:Object.values(Ls)};const{defaultContainer:$s}=Ke,{TrimType:Ms}=js;var Rs=class{constructor(t=$s){this.container=t.container||t,this.name="extract-trim"}mustSkip(t,e){if(e.options&&e.options.skip&&e.options.skip.length>0)for(let s=0;s<e.options.skip.length;s+=1){const n=e.options.skip[s];if(e.options.caseSensitive){if(n===t)return!0}else if(n.toLowerCase()===t.toLowerCase())return!0}return!1}matchBetween(t,e,s){const n=[];let i;do{const r=e.regex.exec(` ${t} `);r?(n.push({type:"trim",subtype:Ms.Between,start:r.index-1,end:e.regex.lastIndex-2,len:r[0].length,accuracy:1,sourceText:r[0],utteranceText:r[0],entity:s}),i=!0):i=!1}while(i);const r=[];for(let t=0;t<n.length;t+=1)this.mustSkip(n[t].utteranceText,e)||r.push(n[t]);return r}findWord(t,e,s=!1,n=!1){const i=[];let r;const a=new RegExp(n?e:` ${e} | ${e}|${e} `,s?"g":"ig");do{const e=a.exec(t);e?(i.push({start:e.index,end:a.lastIndex}),r=!0):r=!1}while(r);return i}getBeforeResults(t,e,s){const n=[];let i=0,r=0;for(let a=0;a<e.length;a+=1){r=e[a].start;const o=t.substring(i,r);n.push({type:"trim",subtype:Ms.Before,start:i,end:r-1,len:o.length,accuracy:.99,sourceText:o,utteranceText:o,entity:s}),i=e[a].end}return n}getBeforeFirstResults(t,e,s){const n=[],i=e[0].start,r=t.substring(0,i);return n.push({type:"trim",subtype:Ms.BeforeFirst,start:0,end:i-1,len:r.length,accuracy:.99,sourceText:r,utteranceText:r,entity:s}),n}getBeforeLastResults(t,e,s){const n=[],i=e[e.length-1].start,r=t.substring(0,i);return n.push({type:"trim",subtype:Ms.BeforeLast,start:0,end:i-1,len:r.length,accuracy:.99,sourceText:r,utteranceText:r,entity:s}),n}getAfterResults(t,e,s){const n=[];let i=0,r=t.length;for(let a=e.length-1;a>=0;a-=1){i=e[a].end;const o=t.substring(i,r);n.unshift({type:"trim",subtype:Ms.After,start:i,end:r-1,len:o.length,accuracy:.99,sourceText:o,utteranceText:o,entity:s}),r=e[a].start}return n}getAfterFirstResults(t,e,s){const n=[],i=e[0].end,r=t.length,a=t.substring(i,r);return n.push({type:"trim",subtype:Ms.AfterFirst,start:i,end:r-1,len:a.length,accuracy:.99,sourceText:a,utteranceText:a,entity:s}),n}getAfterLastResults(t,e,s){const n=[],i=e[e.length-1].end,r=t.length,a=t.substring(i,r);return n.push({type:"trim",subtype:Ms.AfterLast,start:i,end:r-1,len:a.length,accuracy:.99,sourceText:a,utteranceText:a,entity:s}),n}getResults(t,e,s,n){switch(s){case Ms.Before:return this.getBeforeResults(t,e,n);case Ms.BeforeFirst:return this.getBeforeFirstResults(t,e,n);case Ms.BeforeLast:return this.getBeforeLastResults(t,e,n);case Ms.After:return this.getAfterResults(t,e,n);case Ms.AfterFirst:return this.getAfterFirstResults(t,e,n);case Ms.AfterLast:return this.getAfterLastResults(t,e,n);default:return[]}}match(t,e,s,n){const i=[];if(e&&Array.isArray(e.words))for(let r=0;r<e.words.length;r+=1){const a=e.options.noSpaces?e.words[r]:" "+e.words[r],o=this.findWord(t,a);if(!e.options.noSpaces){const s=this.findWord(t,e.words[r]);s.length>0&&0===s[0].start&&o.unshift(s[0])}o.length>0&&i.push(...this.getResults(t,o,s,n))}const r=[];for(let t=0;t<i.length;t+=1)this.mustSkip(i[t].utteranceText,e)||r.push(i[t]);return r}getRules(t){return t.nerRules||[]}extractFromRule(t,e){const s=[];for(let n=0;n<e.rules.length;n+=1){const i=e.rules[n];i.type===Ms.Between?s.push(...this.matchBetween(t,i,e.name)):s.push(...this.match(t,i,i.type,e.name))}return s}extract(t){const e=t,s=this.getRules(e),n=e.edges||[];for(let t=0;t<s.length;t+=1){const i=this.extractFromRule(e.text||e.utterance,s[t]);for(let t=0;t<i.length;t+=1)n.push(i[t])}return n.sort(((t,e)=>t.start-e.start)),e.edges=ks(n,!1),e}run(t){const e=t,s=e.locale||"en";return(this.container.get("extract-trim-"+s)||this).extract(e)}};const{defaultContainer:Is}=Ke;var zs=class{constructor(t=Is){this.container=t.container||t,this.name="extract-builtin"}extract(t){return t}async run(t){const e=t,s=e.locale||"en",n=this.container.get("extract-builtin-"+s)||this,i=await n.extract({text:e.text||e.utterance,locale:e.locale});if(e.edges=e.edges||[],i.edges)for(let t=0;t<i.edges.length;t+=1)e.edges.push(i.edges[t]);if(e.edges=ks(e.edges,!1),e.sourceEntities=e.sourceEntities||[],i.sourceEntities)for(let t=0;t<i.sourceEntities.length;t+=1)e.sourceEntities.push(i.sourceEntities[t]);return e}};const{Clonable:_s}=Ke,{TrimType:Js}=js;class Ws extends _s{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings),this.settings.tag||(this.settings.tag="ner"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.rules={},this.applySettings(this,{pipelineProcess:this.getPipeline(this.settings.tag+"-process")})}registerDefault(){}getRulesByName(t="*",e="",s=!1){if(!this.rules[t]){if(!s)return;this.rules[t]={}}if(!this.rules[t][e]){if(!s)return;this.rules[t][e]={name:e,type:"enum",rules:[]}}return this.rules[t][e]}addRule(t="*",e,s,n){if(Array.isArray(t))for(let i=0;i<t.length;i+=1)this.addRule(t[i],e,s,n);else this.rules[t]||(this.rules[t]={}),this.rules[t][e]||(this.rules[t][e]={name:e,type:s,rules:[]}),this.rules[t][e].rules.push(n)}asString(t){return t&&t.toString?t.toString():JSON.stringify(t)}findRule(t,e){const s=this.asString(e);for(let e=0;e<t.length;e+=1)if(this.asString(t[e])===s)return e;return-1}removeRule(t="*",e,s){if(this.rules[t]&&this.rules[t][e])if(s){const n=this.findRule(this.rules[t][e].rules,s);n>-1&&this.rules[t][e].rules.splice(n,1)}else delete this.rules[t][e]}getRules(t="*"){const e=[];if(this.rules[t]){const s=Object.keys(this.rules[t]);for(let n=0;n<s.length;n+=1)e.push(this.rules[t][s[n]])}if("*"!==t&&this.rules["*"]){const t=Object.keys(this.rules["*"]);for(let s=0;s<t.length;s+=1)e.push(this.rules["*"][t[s]])}return e}decideRules(t){const e=t;return e.nerRules=this.getRules(e.locale||"en"),e}getRuleOption(t,e){for(let s=0;s<t.length;s+=1)if(t[s].option===e)return t[s]}addRuleOptionTexts(t,e,s,n){if(Array.isArray(t))for(let i=0;i<t.length;i+=1)this.addRuleOptionTexts(t[i],e,s,n);else{let i=n||s;Array.isArray(i)||(i=[i]);const r=this.getRulesByName(t,e,!0);let a=this.getRuleOption(r.rules,s);if(a){const t={};for(let e=0;e<a.texts.length;e+=1)t[a.texts[e]]=1;for(let e=0;e<i.length;e+=1)t[i[e]]=1;a.texts=Object.keys(t)}else a={option:s,texts:i},r.rules.push(a)}}removeRuleOptionTexts(t,e,s,n){if(Array.isArray(t))for(let i=0;i<t.length;i+=1)this.removeRuleOptionTexts(t[i],e,s,n);else{let i=n||s;Array.isArray(i)||(i=[i]);const r=this.getRulesByName(t,e,!1);if(r){const t=this.getRuleOption(r.rules,s);if(t){const e={};for(let s=0;s<t.texts.length;s+=1)e[t.texts[s]]=1;for(let t=0;t<i.length;t+=1)delete e[i[t]];t.texts=Object.keys(e)}}}}static str2regex(t){const e=t.lastIndexOf("/");return new RegExp(t.slice(1,e),t.slice(e+1))}static regex2str(t){return t.toString()}addRegexRule(t,e,s){const n="string"==typeof s?Ws.str2regex(s):s,i=n.flags.includes("g")?n:new RegExp(n.source,n.flags+"g");this.addRule(t,e,"regex",i)}addBetweenCondition(t,e,s,n,i){const r=i||{},a=Array.isArray(s)?s:[s],o=Array.isArray(n)?n:[n],u=[];for(let t=0;t<a.length;t+=1)for(let e=0;e<o.length;e+=1){const s=!0===r.noSpaces?a[t]:` ${a[t]} `,n=!0===r.noSpaces?o[e]:` ${o[e]} `;u.push(`(?<=${s})(.*)(?=${n})`)}let c=`/${u.join("|")}/g`;!0!==r.caseSensitive&&(c+="i");const l={type:"between",leftWords:a,rightWords:o,regex:Ws.str2regex(c),options:r};this.addRule(t,e,"trim",l)}addPositionCondition(t,e,s,n,i){const r=i||{},a={type:s,words:Array.isArray(n)?n:[n],options:r};this.addRule(t,e,"trim",a)}addAfterCondition(t,e,s,n){this.addPositionCondition(t,e,Js.After,s,n)}addAfterFirstCondition(t,e,s,n){this.addPositionCondition(t,e,Js.AfterFirst,s,n)}addAfterLastCondition(t,e,s,n){this.addPositionCondition(t,e,Js.AfterLast,s,n)}addBeforeCondition(t,e,s,n){this.addPositionCondition(t,e,Js.Before,s,n)}addBeforeFirstCondition(t,e,s,n){this.addPositionCondition(t,e,Js.BeforeFirst,s,n)}addBeforeLastCondition(t,e,s,n){this.addPositionCondition(t,e,Js.BeforeLast,s,n)}reduceEdges(t){return t.entities=t.edges,delete t.edges,delete t.nerRules,t}async defaultPipelineProcess(t){this.cache||(this.cache={extractEnum:this.container.get("extract-enum"),extractRegex:this.container.get("extract-regex"),extractTrim:this.container.get("extract-trim"),extractBuiltin:this.container.get("extract-builtin")},this.cache.extractEnum||(this.container.use(Ts),this.cache.extractEnum=this.container.get("extract-enum")),this.cache.extractRegex||(this.container.use(Ps),this.cache.extractRegex=this.container.get("extract-regex")),this.cache.extractTrim||(this.container.use(Rs),this.cache.extractTrim=this.container.get("extract-trim")),this.cache.extractBuiltin||(this.container.use(zs),this.cache.extractBuiltin=this.container.get("extract-builtin")));let e=await this.decideRules(t);return this.cache.extractEnum&&(e=await this.cache.extractEnum.run(e)),this.cache.extractRegex&&(e=await this.cache.extractRegex.run(e)),this.cache.extractTrim&&(e=await this.cache.extractTrim.run(e)),this.cache.extractBuiltin&&(e=await this.cache.extractBuiltin.run(e)),e=await this.reduceEdges(e),e}async process(t){const e={threshold:this.settings.threshold||.8,...t};let s;if(e.locale){const t=this.container.getPipeline(`${this.settings.tag}-${e.locale}-process`);t&&(s=await this.runPipeline(e,t))}else this.pipelineProcess&&(s=await this.runPipeline(e,this.pipelineProcess));return s||(s=await this.defaultPipelineProcess(e)),delete s.threshold,s}nameToEntity(t){return`${void 0===this.settings.entityPreffix?"@":this.settings.entityPreffix}${t}${void 0===this.settings.entitySuffix?"":this.settings.entitySuffix}`}entityToName(t){if(!t)return t;let e=t;const s=void 0===this.settings.entityPreffix?"@":this.settings.entityPreffix,n=void 0===this.settings.entitySuffix?"":this.settings.entitySuffix;if(s){if(!e.startsWith(s))return t;e=e.slice(s.length)}if(n){if(!e.endsWith(n))return t;e=e.slice(0,-n.length)}return e}isEntity(t){return this.entityToName(t)!==t}getEntitiesFromUtterance(t,e){e||(e=t,t="es");const s=e.split(/[\s,.!?;:([\]'"¡¿)/]+/).filter((t=>t)),n=[];for(let t=0;t<s.length;t+=1){const e=s[t];this.isEntity(e)&&n.push(this.entityToName(e))}return n}async generateEntityUtterance(t,e){let s={locale:t,utterance:e};s=await this.process(s);const{entities:n}=s;if(!n||!n.length)return e;n.sort(((t,e)=>t.start-e.start));let i=0,r="";for(let t=0;t<n.length;t+=1){const s=n[t],a=e.slice(i,s.start);i=s.end+1,r+=a,r+=this.nameToEntity(s.entity)}return r+=e.slice(n[n.length-1].end+1),r}toJSON(){RegExp.prototype.toJSON=RegExp.prototype.toString;const t={settings:{...this.settings},rules:{...this.rules}};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),Object.keys(t.rules).forEach((e=>{Object.keys(t.rules[e]).forEach((s=>{"regex"===t.rules[e][s].type&&(t.rules[e][s].rules=t.rules[e][s].rules.map((t=>Ws.str2regex(t))))}))})),this.rules=t.rules}}var qs={Ner:Ws,ExtractorEnum:Ts,ExtractorRegex:Ps,ExtractorTrim:Rs,ExtractorBuiltin:zs};const{Clonable:Vs}=Ke;var Us=class extends Vs{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlg-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.responses={},this.applySettings(this,{pipelineFind:this.getPipeline(this.settings.tag+"-find")})}registerDefault(){this.container.registerConfiguration("nlg-manager",{},!1)}findAllAnswers(t){const e=t;return this.responses[e.locale]?e.answers=this.responses[e.locale][e.intent]||[]:e.answers=[],e}filterAnswers(t){const e=t,{answers:s}=e;if(s&&s.length){const t=this.container.get("Evaluator");if(t){const n=e.context||{},i=[];for(let e=0;e<s.length;e+=1){const r=s[e];if(r.opts){const e="string"==typeof r.opts?r.opts:r.opts.condition;e?!0===t.evaluate(e,n)&&i.push(r):i.push(r)}else i.push(r)}e.answers=i}}return e}chooseRandom(t){const e=t,{answers:s}=e;return s&&s.length&&(e.answer=s[Math.floor(Math.random()*s.length)].answer),e}renderText(t,e){if(!t)return t;let s,n=t.answer||t;do{const t=/\((?:[^()]+)\|(?:[^()]+)\)/g.exec(n);if(t){for(let e=0;e<t.length;e+=1){const s=t[e],i=s.substring(1,s.length-1).split("|");n=n.replace(s,i[Math.floor(Math.random()*i.length)])}s=!0}else s=!1}while(s);const i=this.container.get("Template");return i&&e?i.compile(t,e):t.answer?(t.answer=n,t):n}renderRandom(t){const e=t,{answers:s,context:n}=e;for(let t=0;t<s.length;t+=1)s[t]=this.renderText(s[t],n);return e}indexOfAnswer(t,e,s,n){if(!this.responses[t])return-1;if(!this.responses[t][e])return-1;const i=this.responses[t][e];for(let t=0;t<i.length;t+=1){const e=i[t];if(e.answer===s&&JSON.stringify(e.opts)===JSON.stringify(n))return t}return-1}add(t,e,s,n){const i=this.indexOfAnswer(t,e,s,n);if(-1!==i)return this.responses[t][e][i];this.responses[t]||(this.responses[t]={}),this.responses[t][e]||(this.responses[t][e]=[]);const r={answer:s,opts:n};return this.responses[t][e].push(r),r}remove(t,e,s,n){const i=this.indexOfAnswer(t,e,s,n);-1!==i&&this.responses[t][e].splice(i,1)}defaultPipelineFind(t){let e=this.findAllAnswers(t);return e=this.filterAnswers(e),e=this.renderRandom(e),e=this.chooseRandom(e),e}find(t,e,s,n){const i={locale:t,intent:e,context:s,settings:n||this.settings};return this.pipelineFind?this.runPipeline(i,this.pipelineFind):this.defaultPipelineFind(i)}run(t,e){return this.find(t.locale,t.intent,t.context,e)}toJSON(){const t={settings:{...this.settings},responses:this.responses};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.responses=t.responses}};const{Clonable:Ks}=Ke;var Gs={NlgManager:Us,ActionManager:class extends Ks{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="action-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.actions={},this.actionsMap={},this.applySettings(this,{pipelineFind:this.getPipeline(this.settings.tag+"-find")})}registerDefault(){}posAction(t,e,s){if(!this.actions[t])return-1;const n=this.actions[t];for(let t=0;t<n.length;t+=1)if(n[t].action===e&&n[t].parameters.toString()===s.toString())return t;return-1}findActions(t){return(this.actions[t]||[]).map((t=>({...t,fn:this.actionsMap[t.action]})))}async processActions(t,e){const s=this.findActions(t);"object"==typeof e&&(e.actions=s.map((t=>({action:t.action,parameters:t.parameters}))));let n=e;for(const{fn:t,parameters:e}of s)if(t){const s=await t(n,...e||[]);s&&("object"==typeof n?"object"==typeof s?n=s:n.answer=s:n=s)}return n}addAction(t,e,s,n){-1===this.posAction(t,e,s)&&(this.actions[t]||(this.actions[t]=[]),this.actions[t].push({action:e,parameters:s}),n&&(this.actionsMap[e]=n))}removeAction(t,e,s){const n=this.posAction(t,e,s);n>-1&&this.actions[t].splice(n,1)}removeActions(t){delete this.actions[t]}removeActionFromMap(t){delete this.actionsMap[t]}run(t,e){const s=t;return s.settings=s.settings||e||this.settings,this.processActions(t.intent,s)}toJSON(){const t={settings:{...this.settings},actions:this.actions};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.actions=t.actions}}};const{Clonable:Hs}=Ke;var Qs={SentimentAnalyzer:class extends Hs{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="sentiment-analyzer"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.applySettings(this,{pipelinePrepare:this.getPipeline(this.settings.tag+"-prepare"),pipelineProcess:this.getPipeline(this.settings.tag+"-process")})}registerDefault(){this.container.registerConfiguration("sentiment-analyzer",{},!1)}prepare(t,e,s,n){const i=this.getPipeline(this.settings.tag+"-prepare");if(i){const n={text:e,locale:t,settings:s||this.settings};return this.runPipeline(n,i)}if(n){const s=this.container.get("stemmer-"+t)||this.container.get("stemmer-en");if(s)return s.tokenizeAndStem(e)}const r=this.container.get("tokenizer-"+t)||this.container.get("tokenizer-en");return r?r.tokenize(e,!0):e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().split(/[\s,.!?;:([\]'"¡¿)/]+/).filter((t=>t))}async getDictionary(t){const e=t,s=this.container.get("sentiment-"+e.locale);let n;return s&&(s.senticon?n="senticon":s.pattern?n="pattern":s.afinn&&(n="afinn")),n?(e.sentimentDictionary={type:n,dictionary:s[n],negations:s.negations.words,stemmed:void 0!==s.stemmed&&s.stemmed},e):(e.sentimentDictionary={type:n,dictionary:void 0,negations:[],stemmed:!1},e)}async getTokens(t){const e=t;return!e.tokens&&e.sentimentDictionary.type&&(e.tokens=await this.prepare(e.locale,e.utterance||e.text,e.settings,e.sentimentDictionary.stemmed)),e}calculate(t){const e=t;if(e.sentimentDictionary.type){const t=Array.isArray(e.tokens)?e.tokens:Object.keys(e.tokens);if(e.sentimentDictionary.dictionary){const{dictionary:s}=e.sentimentDictionary,{negations:n}=e.sentimentDictionary;let i=0,r=1,a=0;for(let e=0;e<t.length;e+=1){const o=t[e].toLowerCase();-1!==n.indexOf(o)?(r=-1,a+=1):void 0!==s[o]&&(i+=r*s[o],a+=1)}e.sentiment={score:i,numWords:t.length,numHits:a,average:i/t.length,type:e.sentimentDictionary.type,locale:e.locale}}else e.sentiment={score:0,numWords:t.length,numHits:0,average:0,type:e.sentimentDictionary.type,locale:e.locale}}else e.sentiment={score:0,numWords:0,numHits:0,average:0,type:e.sentimentDictionary.type,locale:e.locale};return e.sentiment.score>0?e.sentiment.vote="positive":e.sentiment.score<0?e.sentiment.vote="negative":e.sentiment.vote="neutral",e}async defaultPipelineProcess(t){let e=await this.getDictionary(t);return e=await this.getTokens(e),e=await this.calculate(e),delete e.sentimentDictionary,e}process(t,e){const s=t;return s.settings=s.settings||e||this.settings,this.pipelineProcess?this.runPipeline(s,this.pipelineProcess):this.defaultPipelineProcess(s)}}},Zs={SlotManager:class{constructor(){this.intents={},this.isEmpty=!0}getSlot(t,e){if(this.intents[t])return this.intents[t][e]}existsSlot(t,e){return void 0!==this.getSlot(t,e)}addSlot(t,e,s=!1,n){return this.isEmpty=!1,this.intents[t]||(this.intents[t]={}),this.intents[t][e]={intent:t,entity:e,mandatory:s,locales:n||{}},this.intents[t][e]}removeSlot(t,e){this.intents[t]&&delete this.intents[t][e]}addBatch(t,e){const s=[];return e&&e.length>0&&e.forEach((e=>{let n=this.getSlot(t,e);n||(n=this.addSlot(t,e)),s.push(n)})),s}getIntentEntityNames(t){if(this.intents[t])return Object.keys(this.intents[t])}clear(){this.intents={}}load(t){this.intents=t||{},this.isEmpty=0===Object.keys(this.intents).length}save(){return this.intents}getMandatorySlots(t){const e={},s=this.intents[t];if(s){const t=Object.keys(s);for(let n=0,i=t.length;n<i;n+=1){const i=s[t[n]];i.mandatory&&(e[i.entity]=i)}}return e}cleanContextEntities(t,e){const s=e;if(s.slotFill)return;const n=this.getMandatorySlots(t),i=Object.keys(n);0!==i.length&&i.forEach((t=>{delete s[t]}))}process(t,e){const s=t,n=e;if(this.cleanContextEntities(s.intent,n),n.slotFill&&(s.intent=n.slotFill.intent,s.answer=n.slotFill.answer,s.srcAnswer=n.slotFill.srcAnswer),!s.intent||"None"===s.intent)return!1;n.slotFill&&n.slotFill.intent===s.intent&&(s.entities=[...n.slotFill.entities,...s.entities]);const i=this.getMandatorySlots(s.intent);let r=Object.keys(i);if(0===r.length)return!1;n.slotFill&&s.entities.push({entity:n.slotFill.currentSlot,utteranceText:s.utterance,sourceText:s.utterance,accuracy:.95,start:0,end:s.utterance.length-1,len:s.utterance.length});for(let t=0,e=s.entities.length;t<e;t+=1)delete i[s.entities[t].entity];if(r=Object.keys(i),!r||0===r.length)return!0;n.slotFill&&n.slotFill.intent===s.intent&&(s.localeIso2=n.slotFill.localeIso2),s.slotFill={localeIso2:s.localeIso2,intent:s.intent,entities:s.entities,answer:s.answer,srcAnswer:s.srcAnswer};const a=i[r[0]];return s.slotFill.currentSlot=a.entity,s.srcAnswer=a.locales[s.localeIso2],n.slotFill=s.slotFill,!0}}};const{Clonable:Xs}=Ke;var Ys=class extends Xs{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="context-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.contextDictionary={},this.defaultData={}}registerDefault(){this.container.registerConfiguration("context-manager",{tableName:"context"})}async getInputContextId(t){let e;return this.onGetInputContextId&&(e=await this.onGetInputContextId(t)),!e&&t&&t.activity&&(t.activity.address&&t.activity.address.conversation?e=t.activity.address.conversation.id:t.activity.conversation&&(e=t.activity.conversation.id)),e}async getContext(t){const e=await this.getInputContextId(t);let s;if(e){if(this.settings.tableName){const t=this.container?this.container.get("database"):void 0;t&&(s=await t.findOne(this.settings.tableName,{conversationId:e})||{conversationId:e})}s||(s=this.contextDictionary[e]||{conversationId:e})}else s={};return s._data=this.defaultData,s}async setContext(t,e){const s=this.container.get("logger"),n=await this.getInputContextId(t);if(n){if(!e.id){const s=await this.getContext(t);s&&(e.id=s.id)}const i=Object.keys(e),r={conversationId:n};for(let t=0;t<i.length;t+=1){const s=i[t];s.startsWith("_")||(r[s]=e[s])}if(this.settings.tableName){const t=this.container?this.container.get("database"):void 0;t?await t.save(this.settings.tableName,r):this.contextDictionary[n]=r}else this.contextDictionary[n]=r;this.onCtxUpdate&&(s.debug("emmitting event onCtxUpdate..."),await this.onCtxUpdate(r))}}async resetConversations(){Object.keys(this.contextDictionary).forEach((async t=>{await this.resetConversation(t)}))}async resetConversation(t){this.container.get("logger").debug("reseting context in conversation: "+t);const e=this.contextDictionary[t];Object.keys(e).forEach((t=>{delete e[t]})),this.contextDictionary[t].dialogStack=[],this.contextDictionary[t].variableName=void 0}};const{Clonable:tn,containerBootstrap:en}=Ke,{NluManager:sn,NluNeural:nn}=Fs,{Ner:rn,ExtractorEnum:an,ExtractorRegex:on,ExtractorTrim:un,ExtractorBuiltin:cn}=qs,{ActionManager:ln,NlgManager:hn}=Gs,{SentimentAnalyzer:gn}=Qs,{SlotManager:dn}=Zs;var pn=class extends tn{constructor(t={},e){super({settings:{},container:t.container||e||en()},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlp"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.nluManager=this.container.get("nlu-manager",this.settings.nlu),this.ner=this.container.get("ner",this.settings.ner),this.nlgManager=this.container.get("nlg-manager",this.settings.nlg),this.actionManager=this.container.get("action-manager",this.settings.action),this.sentiment=this.container.get("sentiment-analyzer",this.settings.sentiment),this.slotManager=this.container.get("SlotManager",this.settings.slot),this.contextManager=this.container.get("context-manager",this.settings.context),this.forceNER=this.settings.forceNER,void 0===this.forceNER&&(this.forceNER=!1),this.initialize()}registerDefault(){this.container.registerConfiguration("nlp",{threshold:.5,autoLoad:!0,autoSave:!0,modelFileName:"model.nlp"},!1),this.use(sn),this.use(rn),this.use(an),this.use(on),this.use(un),this.use(cn),this.use(hn),this.use(ln),this.use(nn),this.use(gn),this.use(Ys),this.container.register("SlotManager",dn,!1)}initialize(){if(this.settings.nlu){const t=Object.keys(this.settings.nlu);for(let e=0;e<t.length;e+=1){const s=t[e],n=Object.keys(this.settings.nlu[s]);for(let t=0;t<n.length;t+=1){const e=n[t],i=this.settings.nlu[s][e],{className:r}=i;delete i.className,this.useNlu(r,s,e,i)}}}this.settings.languages&&this.addLanguage(this.settings.languages),this.settings.locales&&this.addLanguage(this.settings.locales),void 0===this.settings.calculateSentiment&&(this.settings.calculateSentiment=!0)}async start(){this.settings.corpora&&await this.addCorpora(this.settings.corpora)}async loadOrTrain(){let t=!1;this.settings.autoLoad&&(t=await this.load(this.settings.modelFileName)),t||await this.train()}useNlu(t,e,s,n){if(e||(e="??"),Array.isArray(e))for(let i=0;i<e.length;i+=1)this.useNlu(t,e[i],s,n);else{const i="string"==typeof t?t:this.container.use(t);let r=this.container.getConfiguration("domain-manager-"+e);r||(r={},this.container.registerConfiguration("domain-manager-"+e,r)),r.nluByDomain||(r.nluByDomain={});const a=s&&"*"!==s?s:"default";r.nluByDomain[a]||(r.nluByDomain[a]={}),r.nluByDomain[a].className=i,r.nluByDomain[a].settings=n}}guessLanguage(t){return this.nluManager.guessLanguage(t)}addLanguage(t){return this.nluManager.addLanguage(t)}removeLanguage(t){return this.nluManager.removeLanguage(t)}addDocument(t,e,s){const n=this.ner.getEntitiesFromUtterance(e);return this.slotManager.addBatch(s,n),this.nluManager.add(t,e,s)}removeDocument(t,e,s){return this.nluManager.remove(t,e,s)}getRulesByName(t,e){return this.ner.getRulesByName(t,e)}addNerRule(t,e,s,n){return this.ner.addRule(t,e,s,n)}removeNerRule(t,e,s){return this.ner.removeRule(t,e,s)}addNerRuleOptionTexts(t,e,s,n){return this.ner.addRuleOptionTexts(t,e,s,n)}removeNerRuleOptionTexts(t,e,s,n){return this.ner.removeRuleOptionTexts(t,e,s,n)}addNerRegexRule(t,e,s){return this.ner.addRegexRule(t,e,s)}addNerBetweenCondition(t,e,s,n,i){return this.ner.addBetweenCondition(t,e,s,n,i)}addNerPositionCondition(t,e,s,n,i){return this.ner.addPositionCondition(t,e,s,n,i)}addNerAfterCondition(t,e,s,n){return this.ner.addAfterCondition(t,e,s,n)}addNerAfterFirstCondition(t,e,s,n){return this.ner.addAfterFirstCondition(t,e,s,n)}addNerAfterLastCondition(t,e,s,n){return this.ner.addAfterLastCondition(t,e,s,n)}addNerBeforeCondition(t,e,s,n){return this.ner.addBeforeCondition(t,e,s,n)}addNerBeforeFirstCondition(t,e,s,n){return this.ner.addBeforeFirstCondition(t,e,s,n)}addNerBeforeLastCondition(t,e,s,n){return this.ner.addBeforeLastCondition(t,e,s,n)}assignDomain(t,e,s){return this.nluManager.assignDomain(t,e,s)}getIntentDomain(t,e){return this.nluManager.getIntentDomain(t,e)}getDomains(){return this.nluManager.getDomains()}addAction(t,e,s,n){return this.actionManager.addAction(t,e,s,n)}getActions(t){return this.actionManager.findActions(t)}removeAction(t,e,s){return this.actionManager.removeAction(t,e,s)}removeActions(t){return this.actionManager.removeActions(t)}addAnswer(t,e,s,n){return this.nlgManager.add(t,e,s,n)}removeAnswer(t,e,s,n){return this.nlgManager.remove(t,e,s,n)}findAllAnswers(t,e){return this.nlgManager.findAllAnswers({locale:t,intent:e}).answers}async addCorpora(t){if(t)if(Array.isArray(t))for(let e=0;e<t.length;e+=1)await this.addCorpus(t[e]);else await this.addCorpus(t)}async addImported(t){let e;if(t.content)e=t.content;else{if(!t.filename)throw new Error("Corpus information without content or file name");{const s=this.container.get("fs");if(e=await s.readFile(t.filename),!e)throw new Error(`Corpus not found "${t.filename}"`)}}let s=this.container.get(t.importer);if(s||(s=this.container.get(t.importer+"-importer")),!s)throw new Error("Corpus importer not found: "+t.importer);const n=s.transform(e,t);for(let t=0;t<n.length;t+=1)this.addCorpus(n[t])}addEntities(t,e){const s=Object.keys(t);for(let n=0;n<s.length;n+=1){const i=s[n];let r=t[i];"string"==typeof r&&(r={regex:[r]});let a=r.locale;if(a||(a=e||"en"),"string"==typeof a&&(a=a.slice(0,2)),r.options){const t=Object.keys(r.options);for(let e=0;e<t.length;e+=1)this.addNerRuleOptionTexts(a,i,t[e],r.options[t[e]])}if(r.regex)if(Array.isArray(r.regex))for(let t=0;t<r.regex.length;t+=1)this.addNerRegexRule(a,i,r.regex[t]);else"string"==typeof r.regex&&r.regex.trim()&&this.addNerRegexRule(a,i,r.regex);if(r.trim)for(let t=0;t<r.trim.length;t+=1)this.addNerPositionCondition(a,i,r.trim[t].position,r.trim[t].words,r.trim[t].opts)}}addData(t,e,s){for(let n=0;n<t.length;n+=1){const i=t[n],{intent:r,utterances:a,answers:o}=i;for(let t=0;t<a.length;t+=1)s&&this.assignDomain(e,r,s.name),this.addDocument(e,a[t],r);if(o)for(let t=0;t<o.length;t+=1){const s=o[t];"string"==typeof s?this.addAnswer(e,r,s):this.addAnswer(e,r,s.answer,s.opts)}}}async addCorpus(t){if(t.importer)await this.addImported(t);else{let e=t;const s=this.container.get("fs");if("string"==typeof t){const n=await s.readFile(t);if(!n)throw new Error(`Corpus not found "${t}"`);e="string"==typeof n?JSON.parse(n):n}if(e.contextData){let{contextData:t}=e;"string"==typeof e.contextData&&(t=JSON.parse(await s.readFile(e.contextData)));const n=this.container.get("context-manager"),i=Object.keys(t);for(let e=0;e<i.length;e+=1)n.defaultData[i[e]]=t[i[e]]}if(e.domains){e.entities&&this.addEntities(e.entities);for(let t=0;t<e.domains.length;t+=1){const s=e.domains[t],{data:n,entities:i}=s,r=s.locale.slice(0,2);this.addLanguage(r),i&&this.addEntities(i,r),this.addData(n,r,s)}}else{const t=e.locale.slice(0,2);this.addLanguage(t);const{data:s,entities:n}=e;n&&this.addEntities(n,t),this.addData(s,t)}}}getSentiment(t,e){return"object"==typeof t?this.sentiment.process(t):(e||(e=t,t=this.guessLanguage(e)),this.sentiment.process({utterance:e,locale:t}))}describeLanguage(t,e){this.nluManager.describeLanguage(t,e)}async train(){this.nluManager.addLanguage(this.settings.languages);const t=await this.nluManager.train();return this.settings.autoSave&&await this.save(this.settings.modelFileName,!0),t}async classify(t,e,s){return this.nluManager.process(t,e,s||this.settings.nlu)}async extractEntities(t,e,s,n){return"object"==typeof t?this.ner.process(t):(e||(e=t,t=void 0),t||(t=this.guessLanguage(e)),await this.ner.process({locale:t,utterance:e,context:s,settings:this.applySettings(n,this.settings.ner)}))}organizeEntities(t){const e={};for(let s=0;s<t.length;s+=1){const n=t[s];e[n.entity]||(e[n.entity]=[]),e[n.entity].push(n)}const s=[];return Object.keys(e).forEach((t=>{const n=e[t];if(1===n.length)s.push(n[0]);else{for(let e=0;e<n.length;e+=1)n[e].alias=`${t}_${e}`;s.push({entity:t,isList:!0,items:n})}})),s}async process(t,e,s,n){let i,r=s;"object"==typeof t&&("object"==typeof e&&e.value?(t=void 0,e=e.value):i=t),i?(t=i.locale,e=i.utterance||i.message||i.text):(e||(e=t,t=void 0),t||(t=this.guessLanguage(e)),i={locale:t,utterance:e,settings:n},n&&(n.activity&&!i.activity&&(i.activity=n.activity),n.conversationId&&!i.activity&&(i.activity={conversation:{id:n.conversationId}}))),r||(r=await this.contextManager.getContext(i)),r.channel=i.channel,r.app=i.app,r.from=i.from||null;const a={locale:t,utterance:e,context:r,settings:this.applySettings(n,this.settings.nlu)};let o=await this.nluManager.process(a);if(this.forceNER||!this.slotManager.isEmpty){const s=await this.ner.generateEntityUtterance(t,e);if(s&&s!==e){const i={locale:t,utterance:s,context:r,settings:this.applySettings(n,this.settings.nlu)},a=await this.nluManager.process(i);a&&(a.score>o.score||"None"===o.intent)&&(o=a,o.utterance=e,o.optionalUtterance=s)}}o.score<this.settings.threshold&&(o.score=1,o.intent="None"),o.context=r,this.forceNER||!this.slotManager.isEmpty?o=await this.ner.process({...o}):(o.entities=[],o.sourceEntities=[]);const u=this.container.get("stemmer-"+o.locale);u&&u.lastFill&&u.lastFill(o);const c=this.organizeEntities(o.entities);o.context.entities||(o.context.entities={});for(let t=0;t<c.length;t+=1){const e=c[t];if(o.context.entities[e.entity]=e,e.isList)for(let t=0;t<e.items.length;t+=1)o.context[e.items[t].alias]=e.items[t].sourceText;o.context[e.entity]=e.isList?e.items[0].sourceText:e.sourceText}const l=await this.nlgManager.run({...o});if(o.answers=l.answers,o.answer=l.answer,o=await this.actionManager.run({...o}),this.settings.calculateSentiment){const s=await this.getSentiment(t,e);o.sentiment=s?s.sentiment:void 0}!this.forceNER&&this.slotManager.isEmpty||(this.slotManager.process(o,r)&&o.entities.forEach((t=>{r[t.entity]=t.option||t.utteranceText})),r.slotFill=o.slotFill),await this.contextManager.setContext(i,r),delete o.context,delete o.settings;const h=i?this.applySettings(i,o):o;if("None"===h.intent&&!h.answer){const t=this.container.get("open-question");if(t){const e=await t.getAnswer(h.locale,h.utterance);e&&e.answer&&e.answer.length>0&&(h.answer=e.answer,h.isOpenQuestionAnswer=!0,h.openQuestionFirstCharacter=e.position,h.openQuestionScore=e.score)}}if(this.onIntent)await this.onIntent(this,h);else{const t=`onIntent(${h.intent})`,e=this.container.getPipeline(t);e&&await this.container.runPipeline(e,h,this)}return h}toJSON(){const t={settings:{...this.settings},nluManager:this.nluManager.toJSON(),ner:this.ner.toJSON(),nlgManager:this.nlgManager.toJSON(),actionManager:this.actionManager.toJSON(),slotManager:this.slotManager.save()};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.nluManager.fromJSON(t.nluManager),this.ner.fromJSON(t.ner),this.nlgManager.fromJSON(t.nlgManager),this.actionManager.fromJSON(t.actionManager),this.slotManager.load(t.slotManager)}export(t=!1){const e=this.toJSON();return t?JSON.stringify(e):JSON.stringify(e,null,2)}import(t){const e="string"==typeof t?JSON.parse(t):t;this.fromJSON(e)}async save(t,e=!1){const s=this.container.get("fs"),n=t||"model.nlp";await s.writeFile(n,this.export(e))}async load(t){const e=this.container.get("fs"),s=t||"model.nlp",n=await e.readFile(s);return!!n&&(this.import(n),!0)}};function fn(t){let e,s,n,i,r,a,o,g;function p(e){t[3](e)}let f={};function w(e){t[4](e)}void 0!==t[0]&&(f.messages=t[0]),n=new nt({props:f}),k.push((()=>_(n,"messages",p)));let A={sendMessage:t[2]};return void 0!==t[1]&&(A.readyForInput=t[1]),a=new ut({props:A}),k.push((()=>_(a,"readyForInput",w))),{c(){e=h("div"),s=h("div"),J(n.$$.fragment),r=d(),J(a.$$.fragment),this.h()},l(t){e=D(t,"DIV",{class:!0});var i=y(e);s=D(i,"DIV",{class:!0});var o=y(s);W(n.$$.fragment,o),r=v(o),W(a.$$.fragment,o),o.forEach(l),i.forEach(l),this.h()},h(){m(s,"class","contentArea svelte-qey93d"),m(e,"class","basicScheme svelte-qey93d")},m(t,i){c(t,e,i),u(e,s),q(n,s,null),u(s,r),q(a,s,null),g=!0},p(t,[e]){const s={};!i&&1&e&&(i=!0,s.messages=t[0],P((()=>i=!1))),n.$set(s);const r={};!o&&2&e&&(o=!0,r.readyForInput=t[1],P((()=>o=!1))),a.$set(r)},i(t){g||(I(n.$$.fragment,t),I(a.$$.fragment,t),g=!0)},o(t){z(n.$$.fragment,t),z(a.$$.fragment,t),g=!1},d(t){t&&l(e),V(n),V(a)}}}function mn(t,e,s){let n,i,r=[{bot:!0,text:"Guten Tag. Du kannst mir alle Fragen rund um Dein Studium an der DHBW stellen. Z.B. Was sind die Aufgaben des Rechnungswesens?"}],a=!1;async function o(t){const e=await i.process("de",t);return console.log(e),void 0===e.answer&&e.classifications[0].score>.3?o(e.classifications[0].intent):void 0===e.answer?"Das genutzte lightweight NLP Modell konnte deine Absicht nicht einordnen.":`"${e.classifications[0].intent}"\n--\x3e ${e.answer}`}return F((async()=>{n=await Ge(),n.use(pn),i=n.get("nlp"),i.settings.autoSave=!1,i.addLanguage("de"),setTimeout((()=>{!async function(){const t=new dt,e=await t.getQAPairsFromMarkDown(),n=t.getDocuments(e),r=t.getAnswers(e);(async()=>{for(const t of n)i.addDocument(t.lang,t.utterance,t.intent);for(const t of r)i.addAnswer(t.lang,t.intent,t.output);await i.train(),s(1,a=!0)})()}()}),30*r[0].text.length)})),[r,a,t=>{const e=r;e.push({bot:!1,text:t}),s(0,r=e),o(t).then((t=>{e.push({bot:!0,text:t}),s(0,r=e)}))},function(t){r=t,s(0,r)},function(t){a=t,s(1,a)}]}new class extends G{constructor(t){var e;super(),document.getElementById("svelte-qey93d-style")||((e=h("style")).id="svelte-qey93d-style",e.textContent=".contentArea.svelte-qey93d{width:90vw;margin-left:auto;margin-right:auto;padding-top:10vh}.basicScheme.svelte-qey93d{background-color:black;min-height:100vh;min-width:100vw}",u(document.head,e)),K(this,t,mn,fn,r,{})}}({target:document.body,props:{}});